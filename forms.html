<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система заявок на видеосъемку</title>
    <script>
        // КРИТИЧЕСКИ ВАЖНО: Функции должны быть определены ДО загрузки DOM
        // Функция для выбора подрядчика (доступна глобально)
        window.selectContractor = function(contractor) {
            try {
                console.log('selectContractor вызвана с параметром:', contractor);
                const mainScreen = document.getElementById('mainScreen');
                const formFigaro = document.getElementById('formFigaro');
                const formTTK = document.getElementById('formTTK');
                const formProducer = document.getElementById('formProducer');
                
                if (!mainScreen || !formFigaro || !formTTK || !formProducer) {
                    console.error('Не найдены элементы форм:', {
                        mainScreen: !!mainScreen,
                        formFigaro: !!formFigaro,
                        formTTK: !!formTTK,
                        formProducer: !!formProducer
                    });
                    // Пробуем еще раз через небольшую задержку
                    setTimeout(function() {
                        window.selectContractor(contractor);
                    }, 100);
                    return;
                }
                
                // Скрываем все
                mainScreen.classList.remove('active');
                formFigaro.classList.remove('active');
                formTTK.classList.remove('active');
                formProducer.classList.remove('active');
            
                // Показываем выбранную форму
                if (contractor === 'figaro') {
                    formFigaro.classList.add('active');
                    const figaroAppDate = document.getElementById('figaro-application-date');
                    if (figaroAppDate) figaroAppDate.valueAsDate = new Date();
                    const today = new Date().toISOString().split('T')[0];
                    const figaroShootingDate = document.getElementById('figaro-shooting-date');
                    const figaroBroadcastDate = document.getElementById('figaro-broadcast-date');
                    if (figaroShootingDate) figaroShootingDate.min = today;
                    if (figaroBroadcastDate) figaroBroadcastDate.min = today;
                } else if (contractor === 'ttk') {
                    formTTK.classList.add('active');
                    const today = new Date().toISOString().split('T')[0];
                    const ttkAppDate = document.getElementById('ttk-application-date');
                    if (ttkAppDate) ttkAppDate.value = today;
                    const ttkShootingDate = document.getElementById('ttk-shooting-date');
                    const ttkBroadcastDate = document.getElementById('ttk-broadcast-date');
                    const ttkSubmissionDate = document.getElementById('ttk-submission-date');
                    if (ttkShootingDate) ttkShootingDate.min = today;
                    if (ttkBroadcastDate) ttkBroadcastDate.min = today;
                    if (ttkSubmissionDate) {
                        const now = new Date();
                        const currentDateTime = now.toISOString().slice(0, 16);
                        ttkSubmissionDate.min = currentDateTime;
                    }
                } else if (contractor === 'producer') {
                    formProducer.classList.add('active');
                    const today = new Date().toISOString().split('T')[0];
                    const producerShootingDate = document.getElementById('producer-shooting-date');
                    if (producerShootingDate) {
                        producerShootingDate.min = today;
                        producerShootingDate.addEventListener('change', function() {
                            if (typeof updateStoryTitleFromDate === 'function') {
                                updateStoryTitleFromDate('producer');
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Ошибка в функции selectContractor:', error);
                alert('Ошибка при открытии формы. Пожалуйста, обновите страницу.');
            }
        };
        
        // Функция для возврата на главный экран (доступна глобально)
        window.goBack = function() {
            const mainScreen = document.getElementById('mainScreen');
            const formFigaro = document.getElementById('formFigaro');
            const formTTK = document.getElementById('formTTK');
            const formProducer = document.getElementById('formProducer');
            
            if (formFigaro) formFigaro.classList.remove('active');
            if (formTTK) formTTK.classList.remove('active');
            if (formProducer) formProducer.classList.remove('active');
            if (mainScreen) mainScreen.classList.add('active');
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #FFE5D9 0%, #FFD7BA 25%, #FFE5CC 50%, #FFF4E6 75%, #FFF8F0 100%);
            background-attachment: fixed;
            color: #2C1810;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Главная страница */
        .main-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            text-align: center;
            padding: 40px 20px;
        }
        
        .main-screen h1 {
            color: #2C1810;
            margin-bottom: 50px;
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: -1px;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 50%, #FFA07A 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 4px 20px rgba(255, 107, 107, 0.2);
        }
        
        .contractor-select {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        
        .contractor-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border-radius: 28px;
            padding: 40px;
            width: 360px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 
                        0 8px 25px rgba(0, 0, 0, 0.05),
                        inset 0 1px 0 rgba(255, 255, 255, 0.6);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .contractor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .contractor-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.12), 
                        0 15px 40px rgba(0, 0, 0, 0.08),
                        inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .contractor-card:active {
            transform: translateY(-6px) scale(1.01);
        }
        
        .contractor-card.figaro {
            color: #4A90E2;
        }
        
        .contractor-card.figaro::before {
            background: linear-gradient(90deg, transparent, #4A90E2, transparent);
        }
        
        .contractor-card.figaro:hover::before {
            opacity: 1;
        }
        
        .contractor-card.ttk {
            color: #FF6B6B;
        }
        
        .contractor-card.ttk::before {
            background: linear-gradient(90deg, transparent, #FF6B6B, transparent);
        }
        
        .contractor-card.ttk:hover::before {
            opacity: 1;
        }
        
        .contractor-card.producer {
            color: #FF8E53;
        }
        
        .contractor-card.producer::before {
            background: linear-gradient(90deg, transparent, #FF8E53, transparent);
        }
        
        .contractor-card.producer:hover::before {
            opacity: 1;
        }
        
        .contractor-card h2 {
            margin-bottom: 16px;
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #2C1810;
        }
        
        .contractor-card p {
            color: #5C4A3A;
            line-height: 1.7;
            margin-bottom: 28px;
            font-size: 15px;
        }
        
        .select-btn {
            padding: 16px 32px;
            border: none;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            position: relative;
            overflow: hidden;
            letter-spacing: -0.2px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        
        .select-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .select-btn:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-figaro {
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
        }
        
        .btn-figaro:hover {
            background: linear-gradient(135deg, #357ABD 0%, #2A5F8F 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
        }
        
        .btn-figaro:active {
            transform: translateY(0);
        }
        
        .btn-ttk {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%);
            color: white;
        }
        
        .btn-ttk:hover {
            background: linear-gradient(135deg, #FF5252 0%, #E53935 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }
        
        .btn-ttk:active {
            transform: translateY(0);
        }
        
        .btn-producer {
            background: linear-gradient(135deg, #FF8E53 0%, #FF7043 100%);
            color: white;
        }
        
        .btn-producer:hover {
            background: linear-gradient(135deg, #FF7043 0%, #FF5722 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 142, 83, 0.4);
        }
        
        .btn-producer:active {
            transform: translateY(0);
        }
        
        /* Общие стили для форм */
        .form-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            padding: 40px;
            border-radius: 28px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1), 
                        0 8px 25px rgba(0, 0, 0, 0.05),
                        inset 0 1px 0 rgba(255, 255, 255, 0.6);
            margin-top: 20px;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        
        .form-container.active {
            display: block;
            animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid;
        }
        
        .form-header.figaro {
            border-color: rgba(74, 144, 226, 0.3);
        }
        
        .form-header.ttk {
            border-color: rgba(255, 107, 107, 0.3);
        }
        
        .form-header.producer {
            border-color: rgba(255, 142, 83, 0.3);
        }
        
        .form-header h1 {
            color: #2C1810;
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .back-btn {
            padding: 12px 24px;
            background: rgba(92, 74, 58, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: #5C4A3A;
            border: 1px solid rgba(92, 74, 58, 0.2);
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: -0.2px;
        }
        
        .back-btn:hover {
            background: rgba(92, 74, 58, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(92, 74, 58, 0.2);
        }
        
        .back-btn:active {
            transform: translateY(0);
        }
        
        .header-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .form-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 30px;
        }
        
        .form-table td {
            padding: 18px 20px;
            border: none;
            border-bottom: 1px solid rgba(92, 74, 58, 0.1);
            vertical-align: top;
            transition: background-color 0.2s ease;
        }
        
        .form-table tr:last-child td {
            border-bottom: none;
        }
        
        .form-table tr:nth-child(even) {
            background-color: rgba(255, 245, 238, 0.5);
        }
        
        .form-table tr:hover {
            background-color: rgba(255, 237, 213, 0.6);
        }
        
        .label {
            font-weight: 600;
            color: #2C1810;
            white-space: nowrap;
            width: 30%;
            font-size: 15px;
            letter-spacing: -0.2px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 14px 18px;
            border: 1.5px solid rgba(92, 74, 58, 0.2);
            border-radius: 14px;
            box-sizing: border-box;
            font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #2C1810;
        }
        
        input:hover, textarea:hover, select:hover {
            border-color: rgba(92, 74, 58, 0.4);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .figaro input:focus, .figaro textarea:focus, .figaro select:focus {
            border-color: #4A90E2;
            outline: none;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.15), 0 4px 12px rgba(74, 144, 226, 0.2);
            transform: translateY(-1px);
        }
        
        .ttk input:focus, .ttk textarea:focus, .ttk select:focus {
            border-color: #FF6B6B;
            outline: none;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.15), 0 4px 12px rgba(255, 107, 107, 0.2);
            transform: translateY(-1px);
        }
        
        .producer input:focus, .producer textarea:focus, .producer select:focus {
            border-color: #FF8E53;
            outline: none;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 4px rgba(255, 142, 83, 0.15), 0 4px 12px rgba(255, 142, 83, 0.2);
            transform: translateY(-1px);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
            line-height: 1.6;
        }
        
        select {
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%235C4A3A' d='M6 8L0 0h12z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 18px center;
            padding-right: 45px;
        }
        
        .equipment-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 16px;
            border-radius: 16px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        .equipment-table th {
            background: linear-gradient(135deg, rgba(255, 142, 83, 0.2) 0%, rgba(255, 107, 107, 0.2) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: #2C1810;
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 15px;
            letter-spacing: -0.2px;
            border-bottom: 2px solid rgba(255, 142, 83, 0.3);
        }
        
        .equipment-table td {
            padding: 14px 20px;
            border: none;
            border-bottom: 1px solid rgba(92, 74, 58, 0.1);
            background: rgba(255, 255, 255, 0.4);
        }
        
        .equipment-table tr:last-child td {
            border-bottom: none;
        }
        
        .small-input {
            width: 60px;
            padding: 8px 10px !important;
            font-size: 15px !important;
            color: #2C1810 !important;
            text-align: center !important;
            background: #FFFFFF !important;
            border: 1.5px solid rgba(92, 74, 58, 0.3) !important;
            border-radius: 10px !important;
            font-weight: 600 !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        }
        
        .small-input:hover {
            border-color: rgba(92, 74, 58, 0.5) !important;
            background: #FFFFFF !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.12) !important;
        }
        
        .small-input:focus {
            border-color: #4A90E2 !important;
            outline: none !important;
            background: #FFFFFF !important;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15), 0 2px 10px rgba(74, 144, 226, 0.2) !important;
            color: #2C1810 !important;
            -webkit-text-fill-color: #2C1810 !important;
        }
        
        .figaro .small-input:focus {
            border-color: #4A90E2 !important;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15) !important;
        }
        
        .ttk .small-input:focus {
            border-color: #FF6B6B !important;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.15) !important;
        }
        
        .producer .small-input:focus {
            border-color: #FF8E53 !important;
            box-shadow: 0 0 0 3px rgba(255, 142, 83, 0.15) !important;
        }
        
        /* Убираем стрелки у number input в некоторых браузерах */
        .small-input::-webkit-inner-spin-button,
        .small-input::-webkit-outer-spin-button {
            opacity: 1;
            height: auto;
        }
        
        .small-input[type="number"] {
            -moz-appearance: textfield;
        }
        
        .small-input[type="number"]::-webkit-inner-spin-button,
        .small-input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: inner-spin-button;
            opacity: 1;
        }
        
        /* Стили для select с классом small-input */
        select.small-input {
            padding: 8px 25px 8px 10px !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath fill='%232C1810' d='M5 6L0 0h10z'/%3E%3C/svg%3E") !important;
            background-repeat: no-repeat !important;
            background-position: right 8px center !important;
            background-size: 10px 6px !important;
            background-color: #FFFFFF !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            cursor: pointer !important;
            color: #2C1810 !important;
        }
        
        select.small-input:hover {
            background-color: #FFFFFF !important;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath fill='%232C1810' d='M5 6L0 0h10z'/%3E%3C/svg%3E") !important;
            background-size: 10px 6px !important;
            background-repeat: no-repeat !important;
            background-position: right 8px center !important;
        }
        
        select.small-input:focus {
            background-color: #FFFFFF !important;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath fill='%232C1810' d='M5 6L0 0h10z'/%3E%3C/svg%3E") !important;
            background-size: 10px 6px !important;
            background-repeat: no-repeat !important;
            background-position: right 8px center !important;
            color: #2C1810 !important;
        }
        
        select.small-input option {
            background-color: #FFFFFF !important;
            color: #2C1810 !important;
        }
        
        /* Убираем стандартные стрелки браузера для select */
        select.small-input::-ms-expand {
            display: none !important;
        }
        
        /* Убеждаемся, что текст виден */
        .small-input,
        .small-input option {
            color: #2C1810 !important;
            -webkit-text-fill-color: #2C1810 !important;
        }
        
        /* Явно задаем цвет для значения в number input */
        input.small-input[type="number"],
        input.small-input[type="number"]::-webkit-textfield-decoration-container {
            color: #2C1810 !important;
            -webkit-text-fill-color: #2C1810 !important;
        }
        
        /* Для браузеров, которые могут скрывать текст */
        .small-input::placeholder {
            color: rgba(92, 74, 58, 0.5) !important;
            opacity: 1 !important;
        }
        
        /* Дополнительная гарантия видимости для всех браузеров */
        input.small-input,
        select.small-input {
            opacity: 1 !important;
            visibility: visible !important;
            display: inline-block !important;
        }
        
        /* Убеждаемся, что значение отображается */
        input.small-input[type="number"] {
            -webkit-appearance: textfield !important;
            -moz-appearance: textfield !important;
            appearance: textfield !important;
        }
        
        .date-time-group {
            display: flex;
            gap: 15px;
        }
        
        .date-time-group > div {
            flex: 1;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1.5px solid rgba(92, 74, 58, 0.15);
        }
        
        button {
            padding: 16px 32px;
            border: none;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: -0.2px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        button:active::before {
            width: 300px;
            height: 300px;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #52C41A 0%, #73D13D 100%);
            color: white;
        }
        
        .submit-btn:hover {
            background: linear-gradient(135deg, #73D13D 0%, #95DE64 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(82, 196, 26, 0.4);
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        .reset-btn {
            background: rgba(92, 74, 58, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: #5C4A3A;
            border: 1.5px solid rgba(92, 74, 58, 0.2);
        }
        
        .reset-btn:hover {
            background: rgba(92, 74, 58, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(92, 74, 58, 0.2);
        }
        
        .reset-btn:active {
            transform: translateY(0);
        }
        
        .pdf-btn {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: -0.2px;
        }
        
        .pdf-btn:hover {
            background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.4);
        }
        
        .pdf-btn:active {
            transform: translateY(0);
        }
        
        .required::after {
            content: " *";
            color: #FF6B6B;
            font-weight: 700;
        }
        
        .note {
            font-size: 13px;
            color: #8B7355;
            margin-top: 8px;
            line-height: 1.5;
            font-style: italic;
        }
        
        .section-title {
            background: linear-gradient(135deg, rgba(255, 237, 213, 0.8) 0%, rgba(255, 245, 238, 0.8) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            font-weight: 700;
            text-align: center;
            padding: 16px;
            margin: 30px 0 20px 0;
            border-radius: 16px;
            font-size: 18px;
            letter-spacing: -0.3px;
            color: #2C1810;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 142, 83, 0.2);
        }
        
        /* Активное состояние */
        .active {
            display: block !important;
        }
        
        /* Адаптивные стили для мобильных устройств */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .main-screen {
                padding: 20px 15px;
            }
            
            .main-screen h1 {
                font-size: 2.5rem;
                margin-bottom: 40px;
            }
            
            .contractor-select {
                flex-direction: column;
                gap: 24px;
                width: 100%;
            }
            
            .contractor-card {
                width: 100%;
                max-width: 100%;
                padding: 32px;
                border-radius: 24px;
            }
            
            .contractor-card h2 {
                font-size: 1.75rem;
            }
            
            .form-container {
                padding: 24px;
                border-radius: 24px;
            }
            
            .form-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            .form-header h1 {
                font-size: 1.75rem;
            }
            
            .header-info {
                flex-direction: column;
                gap: 10px;
                font-size: 12px;
            }
            
            .form-table {
                display: block;
            }
            
            .form-table td {
                padding: 10px;
                display: block;
                width: 100%;
                border-left: none;
                border-right: none;
            }
            
            .form-table tr {
                display: block;
                margin-bottom: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                background-color: white;
            }
            
            .form-table tr:nth-child(even) {
                background-color: white;
            }
            
            .label {
                width: 100%;
                margin-bottom: 5px;
                font-size: 0.9rem;
                padding-bottom: 5px;
                border-bottom: 1px solid #eee;
            }
            
            input, textarea, select {
                font-size: 16px; /* Предотвращает зум на iOS */
                width: 100%;
            }
            
            .equipment-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .equipment-table table {
                min-width: 600px;
            }
            
            .date-time-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions button {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .main-screen h1 {
                font-size: 2rem;
            }
            
            .contractor-card {
                padding: 28px;
                border-radius: 20px;
            }
            
            .contractor-card h2 {
                font-size: 1.5rem;
            }
            
            .form-container {
                padding: 20px;
                border-radius: 20px;
            }
            
            .form-header h1 {
                font-size: 1.5rem;
            }
            
            .form-table td {
                padding: 14px 16px;
            }
            
            input, textarea, select {
                padding: 12px 16px;
                font-size: 15px;
            }
            
            .equipment-table table {
                min-width: 500px;
                font-size: 0.9rem;
            }
            
            button {
                padding: 14px 28px;
                font-size: 16px;
            }
            
            .equipment-table th,
            .equipment-table td {
                padding: 6px;
            }
            
            h3 {
                font-size: 1.1rem;
            }
            
            .back-btn {
                width: 100%;
                text-align: center;
            }
        }
        
        /* Улучшения для touch-устройств */
        @media (hover: none) and (pointer: coarse) {
            button, .back-btn, .select-btn {
                min-height: 44px; /* Минимальный размер для удобного нажатия */
                touch-action: manipulation;
            }
            
            .contractor-card:hover {
                transform: none;
            }
            
            .contractor-card:active {
                transform: scale(0.98);
            }
            
            input, textarea, select {
                font-size: 16px; /* Предотвращает зум на iOS при фокусе */
            }
        }
        
        /* Модальное окно для улучшенной ручной отправки */
        .email-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .email-modal-overlay.show {
            display: flex;
        }
        
        .email-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .email-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f0f0f0;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            color: #666;
        }
        
        .email-modal-close:hover {
            background: #e0e0e0;
        }
        
        .email-success-icon {
            width: 80px;
            height: 80px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
            color: white;
        }
        
        .email-file-info {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .email-file-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }
        
        .email-file-path {
            color: #666;
            font-size: 14px;
            word-break: break-all;
            margin-top: 10px;
        }
        
        .email-instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
        }
        
        .email-instructions ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .email-instructions li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .email-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .email-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .email-btn-primary {
            background: #2196F3;
            color: white;
        }
        
        .email-btn-primary:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }
        
        .email-btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .email-btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .email-btn-close {
            background: #f44336;
            color: white;
        }
        
        .email-btn-close:hover {
            background: #d32f2f;
        }
        
        .email-tip {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
        
        @media (max-width: 600px) {
            .email-modal {
                padding: 20px;
            }
            
            .email-action-buttons {
                flex-direction: column;
            }
            
            .email-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Главный экран выбора -->
        <div id="mainScreen" class="main-screen active">
            <h1>Система заявок на видеосъемку</h1>
            <p style="color: #7f8c8d; margin-bottom: 40px; max-width: 600px; font-size: 1.1rem;">
                Выберите тип заявки для создания заявки на видеосъемку программы "Доброе утро"
            </p>
            <div style="margin-bottom: 20px;">
                <button class="back-btn" onclick="window.location.href='index.html'">← Вернуться на главную</button>
            </div>
            
            <div class="contractor-select">
                <div class="contractor-card figaro" onclick="selectContractor('figaro')">
                    <h2>ВЕК XXL (ФИГАРО)</h2>
                    <p>Заказ-наряд на видеосъемку для подрядчика "ВЕК XXL. TMC"</p>
                    <button class="select-btn btn-figaro">Выбрать ФИГАРО</button>
                </div>
                
                <div class="contractor-card ttk" onclick="selectContractor('ttk')">
                    <h2>Технологический центр ТВ (ТТК)</h2>
                    <p>Заказ-наряд на видеосъемку для подрядчика "Технологический центр ТВ"</p>
                    <button class="select-btn btn-ttk">Выбрать ТТК</button>
                </div>
                
                <div class="contractor-card producer" onclick="selectContractor('producer')">
                    <h2>Заявка продюсерам</h2>
                    <p>Заявка на видеосъемку для продюсеров программы "Доброе утро"</p>
                    <button class="select-btn btn-producer">Создать заявку</button>
                </div>
            </div>
        </div>
        
        <!-- Форма ФИГАРО -->
        <div id="formFigaro" class="form-container figaro">
            <div class="form-header figaro">
                <h1>Заявка на видеосъемку - ВЕК XXL (ФИГАРО)</h1>
                <button class="back-btn" onclick="goBack()">← Назад к выбору</button>
            </div>
            
            <div class="header-info">
                <div>Подрядчик "ВЕК XXL. TMC"</div>
                <div>Заказ-наряд на видеосъемку</div>
                <div>ДУТ "Доброе утро"</div>
            </div>
            
            <form id="shooting-request-form-figaro">
                <table class="form-table">
                    <tr>
                        <td class="label required">Название сюжета:</td>
                        <td>
                            <input type="text" id="figaro-story-title" name="story-title" placeholder="Введите название сюжета" required>
                        </td>
                    </tr>
                    <tr>
                        <td class="label required">Аннотация к съемке и адрес локации:</td>
                        <td>
                            <textarea id="figaro-annotation" name="annotation" placeholder="Введите аннотацию и адрес локации" required></textarea>
                            <div class="note">Пример: Роскачество, Тимирязевская академия Кафедра Пчеловодства, магазин</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Примечания (погода, парковка и т.д.):</td>
                        <td>
                            <textarea id="figaro-notes" name="notes" placeholder="Введите примечания"></textarea>
                            <div class="note">Пример: на улице и в помещении, в магазинах и салонах интервью и съемки</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Аккредитация:</td>
                        <td>
                            <select id="figaro-accreditation" name="accreditation">
                                <option value="yes">ДА</option>
                                <option value="no">НЕТ</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" style="background-color: #ecf0f1; font-weight: bold; text-align: center;">
                            Ответственные за проведение съемок
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Режиссер (редактор):</td>
                        <td>
                            <select id="figaro-director" name="director">
                                <option value="">-- Выберите редактора --</option>
                                <option value="baklanova">Бакланова Н</option>
                                <option value="varkentin">Варкентин О</option>
                                <option value="dubasova">Дубасова Т</option>
                                <option value="zheleznov">Железнов А</option>
                                <option value="izvarina">Изварина М</option>
                                <option value="kazandzhan">Казанджан И</option>
                                <option value="lomovtsev">Ломовцев Э</option>
                                <option value="materanskaya">Матеранская И</option>
                                <option value="mironova">Миронова Н</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Корреспондент:</td>
                        <td>
                            <select id="figaro-correspondent" name="correspondent">
                                <option value="">-- Выберите корреспондента --</option>
                                <option value="abrosimova">Абросимова А.</option>
                                <option value="alkova">Алькова И.</option>
                                <option value="astrahanceva">Астраханцева А.</option>
                                <option value="belyanskaya">Белянская Л</option>
                                <option value="bronzova">Бронзова М</option>
                                <option value="vashuk">Вашук А.</option>
                                <option value="grebenshikova">Гребенщикова А.</option>
                                <option value="zavidova">Завидова А.</option>
                                <option value="ivanova">Иванова А</option>
                                <option value="ionkina">Ионкина К</option>
                                <option value="kobrin">Кобрин И</option>
                                <option value="kovaleva">Ковалева Н.</option>
                                <option value="kozlova">Козлова Ю.</option>
                                <option value="korolkova">Королькова А.</option>
                                <option value="kremeshnaya">Кремешная А.</option>
                                <option value="krylova">Крылова А.</option>
                                <option value="kulabuhova">Кулабухова М</option>
                                <option value="kuzmin-a">Кузьмин А.</option>
                                <option value="kuzmin-d">Кузьмин Д.</option>
                                <option value="kuskova">Кускова М.</option>
                                <option value="lyubchenko">Любченко Н.</option>
                                <option value="makaryan">Макарян К.</option>
                                <option value="molostova">Молостова Ю.</option>
                                <option value="nesterov">Нестеров Ю.</option>
                                <option value="neymanis">Нейманис С.</option>
                                <option value="nikishova">Никишова Е.</option>
                                <option value="nikishicheva">Никишичева О.</option>
                                <option value="nikolaeva">Николаева М.</option>
                                <option value="novohatnyaya">Новохатняя А.</option>
                                <option value="obolenskih">Оболенских В</option>
                                <option value="orehova">Орехова А.</option>
                                <option value="popov">Попов В.</option>
                                <option value="popova-a">Попова А.</option>
                                <option value="popova-e">Попова Е.</option>
                                <option value="pravdina">Правдина Н.</option>
                                <option value="radkevich">Радкевич А</option>
                                <option value="ryzhova">Рыжова А.</option>
                                <option value="savelyeva">Савельева А.</option>
                                <option value="soldatova">Солдатова А.</option>
                                <option value="sotnik">Сотник С.</option>
                                <option value="teliya">Телия А.</option>
                                <option value="torubarova">Торубарова Д</option>
                                <option value="fedorova">Федорова В.</option>
                                <option value="zhukova">Жукова М.</option>
                                <option value="sherstobitova">Шерстобитова О</option>
                                <option value="shuvalova">Шувалова Ю.</option>
                                <option value="yunyaev">Юняев Р.</option>
                                <option value="yakunina">Якунина О</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Продюсер:</td>
                        <td>
                            <select id="figaro-producer" name="producer">
                                <option value="">-- Выберите продюсера --</option>
                                <option value="bykova">Быкова</option>
                                <!-- Другие фамилии будут подгружаться отдельно -->
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Оператор:</td>
                        <td>
                            <select id="figaro-operator" name="operator">
                                <option value="">-- Выберите оператора --</option>
                                <option value="rozhkov">Рожков</option>
                                <option value="ivanovsky">Ивановский</option>
                                <option value="likhachev">Лихачёв</option>
                                <!-- Другие фамилии будут подгружаться отдельно -->
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Видео инженер:</td>
                        <td>
                            <select id="figaro-video-engineer" name="video-engineer">
                                <option value="">-- Выберите видео инженера --</option>
                                <!-- Фамилии будут подгружаться отдельно -->
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" style="background-color: #ecf0f1; font-weight: bold; text-align: center;">
                            Даты и время
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Дата подачи заявки:</td>
                        <td>
                            <input type="date" id="figaro-application-date" name="application-date" required>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Дата съемки:</td>
                        <td>
                            <input type="date" id="figaro-shooting-date" name="shooting-date" required>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Время выезда и завершения съемки:</td>
                        <td>
                            <div class="date-time-group">
                                <div>
                                    <input type="time" id="figaro-start-time" name="start-time" value="09:00">
                                </div>
                                <div style="text-align: center; line-height: 40px;">-</div>
                                <div>
                                    <input type="time" id="figaro-end-time" name="end-time" value="18:00">
                                </div>
                            </div>
                            <div class="note">По умолчанию: 9:00 - 18:00</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Дата эфира:</td>
                        <td>
                            <input type="date" id="figaro-broadcast-date" name="broadcast-date">
                            <div class="note">Оставьте пустым, если дата эфира по готовности</div>
                        </td>
                    </tr>
                </table>
                
                <h3>Оборудование</h3>
                
                <table class="equipment-table">
                    <thead>
                        <tr>
                            <th width="40%">Основной комплект</th>
                            <th width="40%">Дополнительное оборудование</th>
                            <th width="20%">Выбор дополнительного оборудования</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                камера HD SONY (XDCAM, HDCAM) c Объективом CANON\17 накамерным светом
                                <input type="number" class="small-input" value="1" min="0" max="10"> шт
                            </td>
                            <td>Экшн-камера, карты памяти 2шт, система стабилизации или крепления.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Аккумулятор <input type="number" class="small-input" value="2" min="0" max="10"> шт</td>
                            <td>Микрофон ручной с Логотипом Первого канала. Плагон.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Карта памяти <input type="number" class="small-input" value="2" min="0" max="10"> шт</td>
                            <td>Микрофон ручной (проводной) с Логотипом Первого канала. Звуковой кабель xlr 5м.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                Комплект света: DEDOLIGHT 3 прибора.(направленный свет) 1 прибор(заполняющий свет)
                                <input type="number" class="small-input" value="1" min="0" max="10"> шт
                            </td>
                            <td>Радиосистема SENNHEISER EK 100 "ПЕТЛЯ" 1 ШТ.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0">0</option>
                                    <option value="1" selected>1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Светоотражатель флекс <input type="number" class="small-input" value="1" min="0" max="10"> шт</td>
                            <td>"Удочка" микрофонная SENNHEISER.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Кофр транспортный <input type="number" class="small-input" value="1" min="0" max="10"> шт</td>
                            <td>Лайтпанель 1шт Bi-Color Flood DMX.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0">0</option>
                                    <option value="1" selected>1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Дождевик (зимник) для камеры <input type="number" class="small-input" value="1" min="0" max="10"> шт</td>
                            <td>Фильтры.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Наушники SENNHEISER HD280 <input type="number" class="small-input" value="1" min="0" max="10"> шт</td>
                            <td>Объектив широкоугольный 11*</td>
                            <td>
                                <select class="small-input">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Штатив для видеокамеры <input type="number" class="small-input" value="1" min="0" max="10"> шт</td>
                            <td>Широкоугольная линза.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>Монитор к камере.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="form-actions">
                    <button type="reset" class="reset-btn">Очистить форму</button>
                    <button type="button" class="pdf-btn" onclick="exportToDOC('figaro')" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); margin-right: 10px;" title="Выгрузит заявку в формате Word (DOC)">📝 Выгрузить в DOC</button>
                    <button type="submit" class="submit-btn">Отправить заявку</button>
                </div>
            </form>
        </div>
        
        <!-- Форма ТТК -->
        <div id="formTTK" class="form-container ttk">
            <div class="form-header ttk">
                <h1>Заявка на видеосъемку - Технологический центр ТВ (ТТК)</h1>
                <button class="back-btn" onclick="goBack()">← Назад к выбору</button>
            </div>
            
            <div class="header-info">
                <div>Подрядчик "Технологический центр ТВ"</div>
                <div>Заказ-наряд на видеосъемку</div>
                <div>ДУТ "Доброе утро"</div>
            </div>
            
            <form id="shooting-request-form-ttk">
                <table class="form-table">
                    <tr>
                        <td class="label required">Название сюжета:</td>
                        <td>
                            <input type="text" id="ttk-story-title" name="story-title" placeholder="Введите название сюжета" required>
                        </td>
                    </tr>
                    <tr>
                        <td class="label required">Аннотация к съемке и адрес локации:</td>
                        <td>
                            <textarea id="ttk-annotation" name="annotation" placeholder="Введите аннотацию и адрес локации" required></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Примечания (погода, парковка и т.д.):</td>
                        <td>
                            <textarea id="ttk-notes" name="notes" placeholder="Введите примечания"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Аккредитация:</td>
                        <td>
                            <select id="ttk-accreditation" name="accreditation">
                                <option value="no" selected>НЕТ</option>
                                <option value="yes">ДА</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Уточнения (если нужно):</td>
                        <td>
                            <textarea id="ttk-clarifications" name="clarifications" placeholder="Введите уточнения"></textarea>
                        </td>
                    </tr>
                    
                    <tr>
                        <td colspan="2" class="section-title">
                            Ответственные за проведение съемок
                        </td>
                    </tr>
                    
                    <tr>
                        <td class="label">Режиссер (редактор):</td>
                        <td>
                            <select id="ttk-director" name="director">
                                <option value="">-- Выберите редактора --</option>
                                <option value="baklanova">Бакланова Н</option>
                                <option value="varkentin">Варкентин О</option>
                                <option value="dubasova">Дубасова Т</option>
                                <option value="zheleznov">Железнов А</option>
                                <option value="izvarina">Изварина М</option>
                                <option value="kazandzhan">Казанджан И</option>
                                <option value="lomovtsev">Ломовцев Э</option>
                                <option value="materanskaya">Матеранская И</option>
                                <option value="mironova">Миронова Н</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Корреспондент:</td>
                        <td>
                            <select id="ttk-correspondent" name="correspondent">
                                <option value="">-- Выберите корреспондента --</option>
                                <option value="abrosimova">Абросимова А.</option>
                                <option value="alkova">Алькова И.</option>
                                <option value="astrahanceva">Астраханцева А.</option>
                                <option value="belyanskaya">Белянская Л</option>
                                <option value="bronzova">Бронзова М</option>
                                <option value="vashuk">Вашук А.</option>
                                <option value="grebenshikova">Гребенщикова А.</option>
                                <option value="zavidova">Завидова А.</option>
                                <option value="ivanova">Иванова А</option>
                                <option value="ionkina">Ионкина К</option>
                                <option value="kobrin">Кобрин И</option>
                                <option value="kovaleva">Ковалева Н.</option>
                                <option value="kozlova">Козлова Ю.</option>
                                <option value="korolkova">Королькова А.</option>
                                <option value="kremeshnaya">Кремешная А.</option>
                                <option value="krylova">Крылова А.</option>
                                <option value="kulabuhova">Кулабухова М</option>
                                <option value="kuzmin-a">Кузьмин А.</option>
                                <option value="kuzmin-d">Кузьмин Д.</option>
                                <option value="kuskova">Кускова М.</option>
                                <option value="lyubchenko">Любченко Н.</option>
                                <option value="makaryan">Макарян К.</option>
                                <option value="molostova">Молостова Ю.</option>
                                <option value="nesterov">Нестеров Ю.</option>
                                <option value="neymanis">Нейманис С.</option>
                                <option value="nikishova">Никишова Е.</option>
                                <option value="nikishicheva">Никишичева О.</option>
                                <option value="nikolaeva">Николаева М.</option>
                                <option value="novohatnyaya">Новохатняя А.</option>
                                <option value="obolenskih">Оболенских В</option>
                                <option value="orehova">Орехова А.</option>
                                <option value="popov">Попов В.</option>
                                <option value="popova-a">Попова А.</option>
                                <option value="popova-e">Попова Е.</option>
                                <option value="pravdina">Правдина Н.</option>
                                <option value="radkevich">Радкевич А</option>
                                <option value="ryzhova">Рыжова А.</option>
                                <option value="savelyeva">Савельева А.</option>
                                <option value="soldatova">Солдатова А.</option>
                                <option value="sotnik">Сотник С.</option>
                                <option value="teliya">Телия А.</option>
                                <option value="torubarova">Торубарова Д</option>
                                <option value="fedorova">Федорова В.</option>
                                <option value="zhukova">Жукова М.</option>
                                <option value="sherstobitova">Шерстобитова О</option>
                                <option value="shuvalova">Шувалова Ю.</option>
                                <option value="yunyaev">Юняев Р.</option>
                                <option value="yakunina">Якунина О</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Продюсер:</td>
                        <td>
                            <select id="ttk-producer" name="producer">
                                <option value="">-- Выберите продюсера --</option>
                                <!-- Фамилии будут подгружаться отдельно -->
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Оператор:</td>
                        <td>
                            <select id="ttk-operator" name="operator">
                                <option value="">-- Выберите оператора --</option>
                                <!-- Фамилии будут подгружаться отдельно -->
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Видео инженер:</td>
                        <td>
                            <select id="ttk-video-engineer" name="video-engineer">
                                <option value="">-- Выберите видео инженера --</option>
                                <!-- Фамилии будут подгружаться отдельно -->
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Номер автомобиля:</td>
                        <td>
                            <input type="text" id="ttk-car-number" name="car-number" placeholder="Введите номер автомобиля">
                        </td>
                    </tr>
                    
                    <tr>
                        <td colspan="2" class="section-title">
                            Даты и время
                        </td>
                    </tr>
                    
                    <tr>
                        <td class="label">Дата подачи заявки:</td>
                        <td>
                            <input type="date" id="ttk-application-date" name="application-date" required>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Дата съемки:</td>
                        <td>
                            <input type="date" id="ttk-shooting-date" name="shooting-date" required>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Время выезда и завершения съемки:</td>
                        <td>
                            <div class="date-time-group">
                                <div>
                                    <input type="time" id="ttk-start-time" name="start-time" value="13:00">
                                </div>
                                <div style="text-align: center; line-height: 40px;">-</div>
                                <div>
                                    <input type="time" id="ttk-end-time" name="end-time" value="22:00">
                                </div>
                            </div>
                            <div class="note">По умолчанию: 13:00 - 22:00</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Продление:</td>
                        <td>
                            <input type="text" id="ttk-extension" name="extension" placeholder="Укажите продление при необходимости">
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Дата эфира:</td>
                        <td>
                            <input type="date" id="ttk-broadcast-date" name="broadcast-date">
                            <div class="note">Оставьте пустым, если дата эфира по готовности</div>
                        </td>
                    </tr>
                </table>
                
                <h3>Оборудование - Основной комплект 1</h3>
                
                <table class="equipment-table">
                    <thead>
                        <tr>
                            <th width="40%">Основной комплект</th>
                            <th width="40%">Дополнительное оборудование</th>
                            <th width="20%">Выбор дополнительного оборудования</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                Камера PANASONIC AG-HPX500E c накамерным светом
                                <input type="number" class="small-input" value="1" min="0" max="10"> шт
                            </td>
                            <td>Экшн-камера Gopro 11 карты памяти 2шт, система стабилизации или крепления.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0" selected>0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Объектив CANON\17 <input type="number" class="small-input" value="1" min="0" max="10"> шт</td>
                            <td>Удочка микрофонная SENNHEISER.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0" selected>0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Штатив для видеокамеры SACHTLER v 18 <input type="number" class="small-input" value="1" min="0" max="10"> шт</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>Наушники SENNHEISER HD280 <input type="number" class="small-input" value="1" min="0" max="10"> шт</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>Аккумулятор BEILLEN BL-F-BP190 <input type="number" class="small-input" value="2" min="0" max="10"> шт</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>Карта памяти PANASONIC AJ-P2EO32XG <input type="number" class="small-input" value="4" min="0" max="10"> шт</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>
                                Комплект света: DEDOLIGHT 3 прибора (направленный свет). Lowell tota-light 1T-10E 1 прибор (заполняющий свет)
                                <input type="number" class="small-input" value="1" min="0" max="10"> шт
                            </td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>Радиосистема SENNHEISER EK 100 "ПЕТЛЯ" <input type="number" class="small-input" value="1" min="0" max="10"> шт</td>
                            <td>Радиосистема SENNHEISER EK 100 "ПЕТЛЯ" 1 шт.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0" selected>0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Система оцифровки NEXTO DI (жесткий диск) <input type="number" class="small-input" value="1" min="0" max="10"> шт</td>
                            <td>Звуковой пульт SHURE.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0" selected>0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Микрофон ручной (проводной) с Логотипом Первого канала. Звуковой кабель xlr 5м. <input type="number" class="small-input" value="1" min="0" max="10"> шт</td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>Лайтпанель TECPRO FELLONI <input type="number" class="small-input" value="1" min="0" max="10"> шт</td>
                            <td>Лайтпанель TECPRO FELLONI 1 шт.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0" selected>0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Видеомонитор контрольный <input type="number" class="small-input" value="1" min="0" max="10"> шт</td>
                            <td>Объектив широкоугольный 12"</td>
                            <td>
                                <select class="small-input">
                                    <option value="0" selected>0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Дождевик (зимник) для камеры <input type="number" class="small-input" value="1" min="0" max="10"> шт</td>
                            <td>Коптер.</td>
                            <td>
                                <select class="small-input">
                                    <option value="0" selected>0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>Рюкзак для прямого включения "Live-U"</td>
                            <td>
                                <select class="small-input">
                                    <option value="0" selected>0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>Стедикам ronin rs</td>
                            <td>
                                <select class="small-input">
                                    <option value="0" selected>0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>Видеокамера SONY FX 3</td>
                            <td>
                                <select class="small-input">
                                    <option value="0" selected>0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>Камера Panasonic AJ-PX270</td>
                            <td>
                                <select class="small-input">
                                    <option value="0" selected>0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <table class="form-table" style="margin-top: 30px;">
                    <tr>
                        <td class="label">Дата и время сдачи материала в инжест:</td>
                        <td>
                            <input type="datetime-local" id="ttk-submission-date" name="submission-date">
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Инженер инжеста ФИО:</td>
                        <td>
                            <input type="text" id="ttk-engineer-name" name="engineer-name" placeholder="Введите ФИО инженера">
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Подпись:</td>
                        <td>
                            <input type="text" id="ttk-signature" name="signature" placeholder="Подпись">
                        </td>
                    </tr>
                </table>
                
                <div class="form-actions">
                    <button type="reset" class="reset-btn">Очистить форму</button>
                    <button type="button" class="pdf-btn" onclick="exportToDOC('ttk')" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); margin-right: 10px;" title="Выгрузит заявку в формате Word (DOC)">📝 Выгрузить в DOC</button>
                    <button type="submit" class="submit-btn">Отправить заявку</button>
                </div>
            </form>
        </div>
        
        <!-- Форма для продюсеров -->
        <div id="formProducer" class="form-container producer">
            <div class="form-header producer">
                <h1>Заявка продюсерам</h1>
                <button class="back-btn" onclick="goBack()">← Назад к выбору</button>
            </div>
            
            <div class="header-info">
                <div>Заявка на видеосъемку</div>
                <div>Программа "Доброе утро"</div>
                <div>Для продюсеров</div>
            </div>
            
            <form id="shooting-request-form-producer">
                <table class="form-table">
                    <tr>
                        <td class="label required">Название сюжета:</td>
                        <td>
                            <input type="text" id="producer-story-title" name="story-title" placeholder="Введите название сюжета" required>
                        </td>
                    </tr>
                    <tr>
                        <td class="label required">Краткое содержание сюжета:</td>
                        <td>
                            <textarea id="producer-summary" name="summary" placeholder="Введите краткое содержание сюжета" required></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Герои:</td>
                        <td>
                            <textarea id="producer-heroes" name="heroes" placeholder="Укажите героев сюжета"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td class="label required">Дата съемки:</td>
                        <td>
                            <input type="date" id="producer-shooting-date" name="shooting-date" required>
                        </td>
                    </tr>
                    <tr>
                        <td class="label required">Время съемки:</td>
                        <td>
                            <div class="date-time-group">
                                <div>
                                    <input type="time" id="producer-start-time" name="start-time" required>
                                </div>
                                <div style="text-align: center; line-height: 40px;">-</div>
                                <div>
                                    <input type="time" id="producer-end-time" name="end-time" required>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="label required">Корреспондент:</td>
                        <td>
                            <select id="producer-correspondent" name="correspondent" required>
                                <option value="">-- Выберите корреспондента --</option>
                                <option value="abrosimova">Абросимова А.</option>
                                <option value="alkova">Алькова И.</option>
                                <option value="astrahanceva">Астраханцева А.</option>
                                <option value="belyanskaya">Белянская Л</option>
                                <option value="bronzova">Бронзова М</option>
                                <option value="vashuk">Вашук А.</option>
                                <option value="grebenshikova">Гребенщикова А.</option>
                                <option value="zavidova">Завидова А.</option>
                                <option value="ivanova">Иванова А</option>
                                <option value="ionkina">Ионкина К</option>
                                <option value="kobrin">Кобрин И</option>
                                <option value="kovaleva">Ковалева Н.</option>
                                <option value="kozlova">Козлова Ю.</option>
                                <option value="korolkova">Королькова А.</option>
                                <option value="kremeshnaya">Кремешная А.</option>
                                <option value="krylova">Крылова А.</option>
                                <option value="kulabuhova">Кулабухова М</option>
                                <option value="kuzmin-a">Кузьмин А.</option>
                                <option value="kuzmin-d">Кузьмин Д.</option>
                                <option value="kuskova">Кускова М.</option>
                                <option value="lyubchenko">Любченко Н.</option>
                                <option value="makaryan">Макарян К.</option>
                                <option value="molostova">Молостова Ю.</option>
                                <option value="nesterov">Нестеров Ю.</option>
                                <option value="neymanis">Нейманис С.</option>
                                <option value="nikishova">Никишова Е.</option>
                                <option value="nikishicheva">Никишичева О.</option>
                                <option value="nikolaeva">Николаева М.</option>
                                <option value="novohatnyaya">Новохатняя А.</option>
                                <option value="obolenskih">Оболенских В</option>
                                <option value="orehova">Орехова А.</option>
                                <option value="popov">Попов В.</option>
                                <option value="popova-a">Попова А.</option>
                                <option value="popova-e">Попова Е.</option>
                                <option value="pravdina">Правдина Н.</option>
                                <option value="radkevich">Радкевич А</option>
                                <option value="ryzhova">Рыжова А.</option>
                                <option value="savelyeva">Савельева А.</option>
                                <option value="soldatova">Солдатова А.</option>
                                <option value="sotnik">Сотник С.</option>
                                <option value="teliya">Телия А.</option>
                                <option value="torubarova">Торубарова Д</option>
                                <option value="fedorova">Федорова В.</option>
                                <option value="zhukova">Жукова М.</option>
                                <option value="sherstobitova">Шерстобитова О</option>
                                <option value="shuvalova">Шувалова Ю.</option>
                                <option value="yunyaev">Юняев Р.</option>
                                <option value="yakunina">Якунина О</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="label required">Контакты корреспондента:</td>
                        <td>
                            <input type="text" id="producer-correspondent-contacts" name="correspondent-contacts" placeholder="Введите контакты корреспондента (телефон, email)" required>
                        </td>
                    </tr>
                    <tr>
                        <td class="label required">Редактор:</td>
                        <td>
                            <select id="producer-director" name="director" required>
                                <option value="">-- Выберите редактора --</option>
                                <option value="baklanova">Бакланова Н</option>
                                <option value="varkentin">Варкентин О</option>
                                <option value="dubasova">Дубасова Т</option>
                                <option value="zheleznov">Железнов А</option>
                                <option value="izvarina">Изварина М</option>
                                <option value="kazandzhan">Казанджан И</option>
                                <option value="lomovtsev">Ломовцев Э</option>
                                <option value="materanskaya">Матеранская И</option>
                                <option value="mironova">Миронова Н</option>
                            </select>
                        </td>
                    </tr>
                </table>
                
                <div class="form-actions">
                    <button type="reset" class="reset-btn">Очистить форму</button>
                    <button type="submit" class="submit-btn">Отправить заявку</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Функции должны быть определены ДО загрузки DOM
        // Функция для выбора подрядчика (доступна глобально)
        window.selectContractor = function(contractor) {
            try {
                console.log('selectContractor вызвана с параметром:', contractor);
                const mainScreen = document.getElementById('mainScreen');
                const formFigaro = document.getElementById('formFigaro');
                const formTTK = document.getElementById('formTTK');
                const formProducer = document.getElementById('formProducer');
                
                if (!mainScreen || !formFigaro || !formTTK || !formProducer) {
                    console.error('Не найдены элементы форм:', {
                        mainScreen: !!mainScreen,
                        formFigaro: !!formFigaro,
                        formTTK: !!formTTK,
                        formProducer: !!formProducer
                    });
                    // Пробуем еще раз через небольшую задержку
                    setTimeout(function() {
                        window.selectContractor(contractor);
                    }, 100);
                    return;
                }
                
                // Скрываем все
                mainScreen.classList.remove('active');
                formFigaro.classList.remove('active');
                formTTK.classList.remove('active');
                formProducer.classList.remove('active');
            
                // Показываем выбранную форму
                if (contractor === 'figaro') {
                    formFigaro.classList.add('active');
                    const figaroAppDate = document.getElementById('figaro-application-date');
                    if (figaroAppDate) figaroAppDate.valueAsDate = new Date();
                    const today = new Date().toISOString().split('T')[0];
                    const figaroShootingDate = document.getElementById('figaro-shooting-date');
                    const figaroBroadcastDate = document.getElementById('figaro-broadcast-date');
                    if (figaroShootingDate) figaroShootingDate.min = today;
                    if (figaroBroadcastDate) figaroBroadcastDate.min = today;
                } else if (contractor === 'ttk') {
                    formTTK.classList.add('active');
                    const today = new Date().toISOString().split('T')[0];
                    const ttkAppDate = document.getElementById('ttk-application-date');
                    if (ttkAppDate) ttkAppDate.value = today;
                    const ttkShootingDate = document.getElementById('ttk-shooting-date');
                    const ttkBroadcastDate = document.getElementById('ttk-broadcast-date');
                    const ttkSubmissionDate = document.getElementById('ttk-submission-date');
                    if (ttkShootingDate) ttkShootingDate.min = today;
                    if (ttkBroadcastDate) ttkBroadcastDate.min = today;
                    if (ttkSubmissionDate) {
                        const now = new Date();
                        const currentDateTime = now.toISOString().slice(0, 16);
                        ttkSubmissionDate.min = currentDateTime;
                    }
                } else if (contractor === 'producer') {
                    formProducer.classList.add('active');
                    const today = new Date().toISOString().split('T')[0];
                    const producerShootingDate = document.getElementById('producer-shooting-date');
                    if (producerShootingDate) {
                        producerShootingDate.min = today;
                        producerShootingDate.addEventListener('change', function() {
                            updateStoryTitleFromDate('producer');
                        });
                    }
                }
            } catch (error) {
                console.error('Ошибка в функции selectContractor:', error);
                alert('Ошибка при открытии формы. Пожалуйста, обновите страницу.');
            }
        };
        
        // Функция для возврата на главный экран (доступна глобально)
        window.goBack = function() {
            const mainScreen = document.getElementById('mainScreen');
            const formFigaro = document.getElementById('formFigaro');
            const formTTK = document.getElementById('formTTK');
            const formProducer = document.getElementById('formProducer');
            
            if (formFigaro) formFigaro.classList.remove('active');
            if (formTTK) formTTK.classList.remove('active');
            if (formProducer) formProducer.classList.remove('active');
            if (mainScreen) mainScreen.classList.add('active');
        };
        
        // Функция для автоматического обновления названия сюжета на основе даты съемки
        function updateStoryTitleFromDate(formType) {
            let shootingDateInput, titleInput;
            
            if (formType === 'figaro') {
                shootingDateInput = document.getElementById('figaro-shooting-date');
                titleInput = document.getElementById('figaro-story-title');
            } else if (formType === 'ttk') {
                shootingDateInput = document.getElementById('ttk-shooting-date');
                titleInput = document.getElementById('ttk-story-title');
            } else if (formType === 'producer') {
                shootingDateInput = document.getElementById('producer-shooting-date');
                titleInput = document.getElementById('producer-story-title');
            }
            
            if (shootingDateInput && titleInput && shootingDateInput.value) {
                const date = new Date(shootingDateInput.value);
                // Форматируем дату в формат ДД.ММ.ГГГГ
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const formattedDate = `${day}.${month}.${year}`;
                
                // Устанавливаем название в формате "Съемка от ДД.ММ.ГГГГ"
                titleInput.value = `Съемка от ${formattedDate}`;
            }
        }
        
        // Функция для выбора подрядчика (доступна глобально)
        window.selectContractor = function(contractor) {
            try {
                console.log('selectContractor вызвана с параметром:', contractor);
                const mainScreen = document.getElementById('mainScreen');
                const formFigaro = document.getElementById('formFigaro');
                const formTTK = document.getElementById('formTTK');
                const formProducer = document.getElementById('formProducer');
                
                if (!mainScreen || !formFigaro || !formTTK || !formProducer) {
                    console.error('Не найдены элементы форм:', {
                        mainScreen: !!mainScreen,
                        formFigaro: !!formFigaro,
                        formTTK: !!formTTK,
                        formProducer: !!formProducer
                    });
                    return;
                }
                
                // Скрываем все
                mainScreen.classList.remove('active');
                formFigaro.classList.remove('active');
                formTTK.classList.remove('active');
                formProducer.classList.remove('active');
            
            // Показываем выбранную форму
            if (contractor === 'figaro') {
                formFigaro.classList.add('active');
                // Устанавливаем дату подачи заявки на сегодня для ФИГАРО
                document.getElementById('figaro-application-date').valueAsDate = new Date();
                // Устанавливаем минимальную дату для съемки
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('figaro-shooting-date').min = today;
                document.getElementById('figaro-broadcast-date').min = today;
            } else if (contractor === 'ttk') {
                formTTK.classList.add('active');
                // Устанавливаем дату подачи заявки на сегодня для ТТК
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('ttk-application-date').value = today;
                // Устанавливаем минимальные даты
                document.getElementById('ttk-shooting-date').min = today;
                document.getElementById('ttk-broadcast-date').min = today;
                // Устанавливаем минимальную дату для сдачи материала
                const now = new Date();
                const currentDateTime = now.toISOString().slice(0, 16);
                document.getElementById('ttk-submission-date').min = currentDateTime;
            } else if (contractor === 'producer') {
                formProducer.classList.add('active');
                // Устанавливаем минимальную дату для съемки
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('producer-shooting-date').min = today;
                // Добавляем обработчик для автоматического названия по дате съемки
                document.getElementById('producer-shooting-date').addEventListener('change', function() {
                    updateStoryTitleFromDate('producer');
                });
            }
            } catch (error) {
                console.error('Ошибка в функции selectContractor:', error);
                alert('Ошибка при открытии формы. Пожалуйста, обновите страницу.');
            }
        };
        
        // Функция для возврата на главный экран (доступна глобально)
        window.goBack = function() {
            const mainScreen = document.getElementById('mainScreen');
            const formFigaro = document.getElementById('formFigaro');
            const formTTK = document.getElementById('formTTK');
            const formProducer = document.getElementById('formProducer');
            
            // Скрываем все формы
            formFigaro.classList.remove('active');
            formTTK.classList.remove('active');
            formProducer.classList.remove('active');
            
            // Показываем главный экран
            mainScreen.classList.add('active');
        };
        
        // Функция для автоматического обновления названия сюжета на основе даты съемки
        function updateStoryTitleFromDate(formType) {
            let shootingDateInput, titleInput;
            
            if (formType === 'figaro') {
                shootingDateInput = document.getElementById('figaro-shooting-date');
                titleInput = document.getElementById('figaro-story-title');
            } else if (formType === 'ttk') {
                shootingDateInput = document.getElementById('ttk-shooting-date');
                titleInput = document.getElementById('ttk-story-title');
            } else if (formType === 'producer') {
                shootingDateInput = document.getElementById('producer-shooting-date');
                titleInput = document.getElementById('producer-story-title');
            }
            
            if (shootingDateInput && titleInput && shootingDateInput.value) {
                const date = new Date(shootingDateInput.value);
                // Форматируем дату в формат ДД.ММ.ГГГГ
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const formattedDate = `${day}.${month}.${year}`;
                
                // Устанавливаем название в формате "Съемка от ДД.ММ.ГГГГ"
                titleInput.value = `Съемка от ${formattedDate}`;
            }
        }
        
        // Функция сбора данных оборудования
        function collectEquipment(formId) {
            const equipment = [];
            const equipmentTable = document.querySelector(`#${formId} .equipment-table tbody`);
            if (equipmentTable) {
                const rows = equipmentTable.querySelectorAll('tr');
                rows.forEach(row => {
                    // Получаем первую ячейку (основное оборудование)
                    const mainCell = row.querySelector('td:first-child');
                    // Получаем вторую ячейку (дополнительное оборудование)
                    const additionalCell = row.querySelector('td:nth-child(2)');
                    // Получаем третью ячейку (выбор дополнительного оборудования)
                    const selectCell = row.querySelector('td:last-child');
                    
                    // Извлекаем название основного оборудования (без input и количества)
                    let mainEquip = '';
                    let mainQuantity = 0;
                    if (mainCell) {
                        // Клонируем ячейку, чтобы удалить input без изменения оригинала
                        const mainCellClone = mainCell.cloneNode(true);
                        const quantityInput = mainCellClone.querySelector('input[type="number"]');
                        if (quantityInput) {
                            mainQuantity = parseInt(quantityInput.value) || 0;
                            quantityInput.remove(); // Удаляем input из клона
                        }
                        // Получаем текст без input
                        mainEquip = mainCellClone.textContent.trim().replace(/\s+/g, ' ');
                    }
                    
                    // Извлекаем название дополнительного оборудования
                    let additionalEquip = '';
                    let additionalQuantity = 0;
                    if (additionalCell) {
                        additionalEquip = additionalCell.textContent.trim().replace(/\s+/g, ' ');
                    }
                    
                    // Извлекаем количество дополнительного оборудования из select
                    if (selectCell) {
                        const additionalSelect = selectCell.querySelector('select');
                        if (additionalSelect) {
                            additionalQuantity = parseInt(additionalSelect.value) || 0;
                        }
                    }
                    
                    // Добавляем только если есть хотя бы одно поле заполнено
                    if (mainEquip || additionalEquip) {
                        equipment.push({
                            main: mainEquip,
                            mainQuantity: mainQuantity,
                            additional: additionalEquip,
                            additionalQuantity: additionalQuantity
                        });
                    }
                });
            }
            return equipment;
        }

        // Обработка отправки формы ФИГАРО
        document.getElementById('shooting-request-form-figaro').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Проверка обязательных полей
            const requiredFields = document.querySelectorAll('#shooting-request-form-figaro [required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = '#e74c3c';
                } else {
                    field.style.borderColor = '#bdc3c7';
                }
            });
            
            if (!isValid) {
                alert('Пожалуйста, заполните все обязательные поля (отмечены *).');
                return;
            }
            
            // Собираем данные формы
            // Получаем русские названия из select элементов
            const directorSelect = document.getElementById('figaro-director');
            const correspondentSelect = document.getElementById('figaro-correspondent');
            const producerSelect = document.getElementById('figaro-producer');
            const operatorSelect = document.getElementById('figaro-operator');
            const videoEngineerSelect = document.getElementById('figaro-video-engineer');
            
            const formData = {
                contractor: 'figaro',
                storyTitle: document.getElementById('figaro-story-title').value,
                annotation: document.getElementById('figaro-annotation').value,
                notes: document.getElementById('figaro-notes').value,
                accreditation: document.getElementById('figaro-accreditation').value,
                director: directorSelect.options[directorSelect.selectedIndex]?.text || directorSelect.value || '',
                correspondent: correspondentSelect.options[correspondentSelect.selectedIndex]?.text || correspondentSelect.value || '',
                producer: producerSelect.options[producerSelect.selectedIndex]?.text || producerSelect.value || '',
                operator: operatorSelect.options[operatorSelect.selectedIndex]?.text || operatorSelect.value || '',
                videoEngineer: videoEngineerSelect.options[videoEngineerSelect.selectedIndex]?.text || videoEngineerSelect.value || '',
                applicationDate: document.getElementById('figaro-application-date').value,
                shootingDate: document.getElementById('figaro-shooting-date').value,
                startTime: document.getElementById('figaro-start-time').value,
                endTime: document.getElementById('figaro-end-time').value,
                broadcastDate: document.getElementById('figaro-broadcast-date').value || null,
                equipment: collectEquipment('shooting-request-form-figaro')
            };
            
            // Сохраняем через applicationManager
            if (typeof applicationManager !== 'undefined') {
                const newApp = applicationManager.createApplication(formData);
                
                // Создаем и отправляем Excel документ
                createExcelDocumentAndSend(formData, newApp.id);
                
                alert('Заявка ВЕК XXL (ФИГАРО) успешно отправлена! Номер заявки: ' + newApp.id.substring(0, 8) + '\n\nExcel файл будет создан и предложен для отправки на pendeho098rus@yandex.ru');
                this.reset();
                goBack();
            } else {
                alert('Ошибка: система данных не загружена. Убедитесь, что файл data.js подключен.');
            }
        });
        
        // Обработка отправки формы ТТК
        document.getElementById('shooting-request-form-ttk').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Проверка обязательных полей
            const requiredFields = document.querySelectorAll('#shooting-request-form-ttk [required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = '#e74c3c';
                } else {
                    field.style.borderColor = '#bdc3c7';
                }
            });
            
            if (!isValid) {
                alert('Пожалуйста, заполните все обязательные поля (отмечены *).');
                return;
            }
            
            // Собираем данные формы
            // Получаем русские названия из select элементов
            const directorSelect = document.getElementById('ttk-director');
            const correspondentSelect = document.getElementById('ttk-correspondent');
            const producerSelect = document.getElementById('ttk-producer');
            const operatorSelect = document.getElementById('ttk-operator');
            const videoEngineerSelect = document.getElementById('ttk-video-engineer');
            
            const formData = {
                contractor: 'ttk',
                storyTitle: document.getElementById('ttk-story-title').value,
                annotation: document.getElementById('ttk-annotation').value,
                notes: document.getElementById('ttk-notes').value,
                accreditation: document.getElementById('ttk-accreditation').value,
                clarifications: document.getElementById('ttk-clarifications').value,
                director: directorSelect.options[directorSelect.selectedIndex]?.text || directorSelect.value || '',
                correspondent: correspondentSelect.options[correspondentSelect.selectedIndex]?.text || correspondentSelect.value || '',
                producer: producerSelect.options[producerSelect.selectedIndex]?.text || producerSelect.value || '',
                operator: operatorSelect.options[operatorSelect.selectedIndex]?.text || operatorSelect.value || '',
                videoEngineer: videoEngineerSelect.options[videoEngineerSelect.selectedIndex]?.text || videoEngineerSelect.value || '',
                carNumber: document.getElementById('ttk-car-number').value,
                applicationDate: document.getElementById('ttk-application-date').value,
                shootingDate: document.getElementById('ttk-shooting-date').value,
                startTime: document.getElementById('ttk-start-time').value,
                endTime: document.getElementById('ttk-end-time').value,
                extension: document.getElementById('ttk-extension').value,
                broadcastDate: document.getElementById('ttk-broadcast-date').value || null,
                submissionDate: document.getElementById('ttk-submission-date').value || null,
                engineerName: document.getElementById('ttk-engineer-name').value,
                signature: document.getElementById('ttk-signature').value,
                equipment: collectEquipment('shooting-request-form-ttk')
            };
            
            // Сохраняем через applicationManager
            if (typeof applicationManager !== 'undefined') {
                const newApp = applicationManager.createApplication(formData);
                
                // Создаем и отправляем Excel документ
                createExcelDocumentAndSend(formData, newApp.id);
                
                alert('Заявка ТТК успешно отправлена! Номер заявки: ' + newApp.id.substring(0, 8) + '\n\nExcel файл будет создан и предложен для отправки на pendeho098rus@yandex.ru');
                this.reset();
                goBack();
            } else {
                alert('Ошибка: система данных не загружена. Убедитесь, что файл data.js подключен.');
            }
        });
        
        // Обработка отправки формы для продюсеров
        document.getElementById('shooting-request-form-producer').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Проверка обязательных полей
            const requiredFields = document.querySelectorAll('#shooting-request-form-producer [required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = '#e74c3c';
                } else {
                    field.style.borderColor = '#bdc3c7';
                }
            });
            
            if (!isValid) {
                alert('Пожалуйста, заполните все обязательные поля (отмечены *).');
                return;
            }
            
            // Получаем текстовые значения из select элементов перед отправкой
            const correspondentSelect = document.getElementById('producer-correspondent');
            const directorSelect = document.getElementById('producer-director');
            const correspondentText = correspondentSelect.options[correspondentSelect.selectedIndex]?.text || correspondentSelect.value;
            const directorText = directorSelect.options[directorSelect.selectedIndex]?.text || directorSelect.value;
            
            // Собираем данные формы
            const formData = {
                contractor: 'producer',
                storyTitle: document.getElementById('producer-story-title').value,
                summary: document.getElementById('producer-summary').value,
                heroes: document.getElementById('producer-heroes').value,
                shootingDate: document.getElementById('producer-shooting-date').value,
                startTime: document.getElementById('producer-start-time').value,
                endTime: document.getElementById('producer-end-time').value,
                correspondent: document.getElementById('producer-correspondent').value,
                correspondentText: correspondentText,
                correspondentContacts: document.getElementById('producer-correspondent-contacts').value,
                director: document.getElementById('producer-director').value,
                directorText: directorText,
                applicationDate: new Date().toISOString().split('T')[0]
            };
            
            // Сохраняем через applicationManager
            if (typeof applicationManager !== 'undefined') {
                const newApp = applicationManager.createApplication(formData);
                
                // Создаем и отправляем Word документ
                createWordDocumentAndSend(formData, newApp.id);
                
                alert('Заявка продюсерам успешно создана! Номер заявки: ' + newApp.id.substring(0, 8) + '\n\nWord документ будет создан и предложен для отправки на pendeho098rus@yandex.ru');
                this.reset();
                goBack();
            } else {
                alert('Ошибка: система данных не загружена. Убедитесь, что файл data.js подключен.');
            }
        });
        
        // Сброс стилей при вводе для всех форм
        document.querySelectorAll('input, textarea, select').forEach(element => {
            element.addEventListener('input', function() {
                this.style.borderColor = '#bdc3c7';
            });
        });
        
        // Инициализация дат при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Устанавливаем дату подачи заявки на сегодня для ФИГАРО (на случай если форма открывается напрямую)
            document.getElementById('figaro-application-date').valueAsDate = new Date();
            
            // Добавляем обработчик для автоматического названия по дате съемки для ФИГАРО
            document.getElementById('figaro-shooting-date').addEventListener('change', function() {
                updateStoryTitleFromDate('figaro');
            });
            
            // Устанавливаем дату подачи заявки на сегодня для ТТК
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ttk-application-date').value = today;
            
            // Добавляем обработчик для автоматического названия по дате съемки для ТТК
            document.getElementById('ttk-shooting-date').addEventListener('change', function() {
                updateStoryTitleFromDate('ttk');
            });
            
            // Добавляем обработчик для автоматического названия по дате съемки для продюсеров
            document.getElementById('producer-shooting-date').addEventListener('change', function() {
                updateStoryTitleFromDate('producer');
            });
        });
        
        // Универсальная функция для создания Word документа и отправки на почту
        // Функция для заполнения шаблона данными с сохранением стилей
        function fillTemplateData(ws, formData, formatDate, formatDateTime) {
            const range = XLSX.utils.decode_range(ws['!ref'] || 'A1');
            
            // Ищем и заполняем ячейки по содержимому, сохраняя стили
            for (let R = range.s.r; R <= range.e.r; R++) {
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                    const cell = ws[cellAddress];
                    
                    if (cell && cell.v) {
                        const cellValue = String(cell.v);
                        
                        // Заполняем данные на основе содержимого ячейки, сохраняя стили
                        if (cellValue.includes('Название сюжета')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            // Сохраняем существующий стиль из шаблона
                            if (existingCell && existingCell.s) {
                                ws[valueCell].s = existingCell.s;
                            }
                            ws[valueCell].v = formData.storyTitle || '';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Аннотация')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.annotation || '';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Примечания')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.notes || '';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Аккредитация')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.accreditation === 'yes' ? 'ДА' : 'НЕТ';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Уточнения')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.clarifications || '';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Режиссер') || cellValue.includes('редактор')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.director || '';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Корреспондент')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.correspondent || '';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Продюсер')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.producer || '';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Оператор')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.operator || '';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Видеоинженер')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.videoEngineer || '';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Номер машины')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.carNumber || '';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Дата подачи заявки')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formatDate(formData.applicationDate);
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Дата съемки')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formatDate(formData.shootingDate);
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Время съемки')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = `${formData.startTime || ''} - ${formData.endTime || ''}`;
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Продление')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.extension || '';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Дата эфира')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.broadcastDate ? formatDate(formData.broadcastDate) : '';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Дата и время сдачи')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.submissionDate ? formatDateTime(formData.submissionDate.split('T')[0], formData.submissionDate.split('T')[1]) : '';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Инженер инжеста')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.engineerName || '';
                            ws[valueCell].t = 's';
                        } else if (cellValue.includes('Подпись')) {
                            const valueCell = XLSX.utils.encode_cell({r: R, c: C + 1});
                            const existingCell = ws[valueCell];
                            if (!ws[valueCell]) ws[valueCell] = {};
                            if (existingCell && existingCell.s) ws[valueCell].s = existingCell.s;
                            ws[valueCell].v = formData.signature || '';
                            ws[valueCell].t = 's';
                        }
                    }
                }
            }
            
            // Заполняем оборудование
            fillEquipmentData(ws, formData, range);
        }
        
        // Функция для заполнения данных об оборудовании
        function fillEquipmentData(ws, formData, range) {
            if (!formData.equipment || formData.equipment.length === 0) return;
            
            // Ищем строку с заголовком "Основной комплект" или "Оборудование"
            let equipmentStartRow = -1;
            for (let R = range.s.r; R <= range.e.r; R++) {
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                    const cell = ws[cellAddress];
                    if (cell && cell.v) {
                        const cellValue = String(cell.v);
                        if (cellValue.includes('Основной комплект') || cellValue.includes('Оборудование')) {
                            equipmentStartRow = R + 1; // Следующая строка после заголовка
                            break;
                        }
                    }
                }
                if (equipmentStartRow !== -1) break;
            }
            
            if (equipmentStartRow === -1) {
                // Если не нашли заголовок, добавляем в конец
                equipmentStartRow = range.e.r + 1;
            }
            
            // Заполняем оборудование, сохраняя стили из шаблона
            formData.equipment.forEach((eq, index) => {
                const row = equipmentStartRow + index;
                const mainCell = XLSX.utils.encode_cell({r: row, c: 0});
                const additionalCell = XLSX.utils.encode_cell({r: row, c: 1});
                
                // Сохраняем стили из существующих ячеек шаблона
                const existingMainCell = ws[mainCell];
                const existingAdditionalCell = ws[additionalCell];
                
                if (!ws[mainCell]) ws[mainCell] = {};
                if (existingMainCell && existingMainCell.s) {
                    ws[mainCell].s = existingMainCell.s;
                }
                ws[mainCell].v = eq.main ? `${eq.main}${eq.mainQuantity > 0 ? ` (${eq.mainQuantity} шт.)` : ''}` : '';
                ws[mainCell].t = 's';
                
                if (!ws[additionalCell]) ws[additionalCell] = {};
                if (existingAdditionalCell && existingAdditionalCell.s) {
                    ws[additionalCell].s = existingAdditionalCell.s;
                }
                ws[additionalCell].v = eq.additional ? `${eq.additional}${eq.additionalQuantity > 0 ? ` (${eq.additionalQuantity} шт.)` : ''}` : '';
                ws[additionalCell].t = 's';
            });
            
            // Обновляем диапазон
            const newRange = XLSX.utils.decode_range(ws['!ref'] || 'A1');
            newRange.e.r = Math.max(newRange.e.r, equipmentStartRow + formData.equipment.length - 1);
            ws['!ref'] = XLSX.utils.encode_range(newRange);
        }
        
        // Функция для создания форматированного листа (если шаблон недоступен)
        function createFormattedSheet(formData, formatDate, formatDateTime) {
            let sheetData = [];
            
            if (formData.contractor === 'figaro') {
                sheetData = [
                    ['Заявка на видеосъемку - ВЕК XXL (ФИГАРО)'],
                    ['Программа "Доброе утро"'],
                    [''],
                    ['Название сюжета:', formData.storyTitle || ''],
                    ['Аннотация к съемке и адрес локации:', formData.annotation || ''],
                    ['Примечания (погода, парковка и т.д.):', formData.notes || ''],
                    ['Аккредитация:', formData.accreditation === 'yes' ? 'ДА' : 'НЕТ'],
                    [''],
                    ['Ответственные за проведение съемок'],
                    ['Режиссер (редактор):', formData.director || ''],
                    ['Корреспондент:', formData.correspondent || ''],
                    ['Продюсер:', formData.producer || ''],
                    ['Оператор:', formData.operator || ''],
                    ['Видеоинженер:', formData.videoEngineer || ''],
                    [''],
                    ['Дата подачи заявки:', formatDate(formData.applicationDate)],
                    ['Дата съемки:', formatDate(formData.shootingDate)],
                    ['Время съемки:', `${formData.startTime || ''} - ${formData.endTime || ''}`],
                    ['Дата эфира:', formData.broadcastDate ? formatDate(formData.broadcastDate) : ''],
                    [''],
                    ['Оборудование'],
                    ['Основной комплект', 'Дополнительное оборудование']
                ];
                
                if (formData.equipment && formData.equipment.length > 0) {
                    formData.equipment.forEach(eq => {
                        const mainText = eq.main ? `${eq.main}${eq.mainQuantity > 0 ? ` (${eq.mainQuantity} шт.)` : ''}` : '';
                        const additionalText = eq.additional ? `${eq.additional}${eq.additionalQuantity > 0 ? ` (${eq.additionalQuantity} шт.)` : ''}` : '';
                        sheetData.push([mainText, additionalText]);
                    });
                }
            } else if (formData.contractor === 'ttk') {
                sheetData = [
                    ['Заявка на видеосъемку - Технологический центр ТВ (ТТК)'],
                    ['Программа "Доброе утро"'],
                    [''],
                    ['Название сюжета:', formData.storyTitle || ''],
                    ['Аннотация к съемке и адресу локации:', formData.annotation || ''],
                    ['Примечания (погода, парковка и т.д.):', formData.notes || ''],
                    ['Аккредитация:', formData.accreditation === 'yes' ? 'ДА' : 'НЕТ'],
                    ['Уточнения:', formData.clarifications || ''],
                    [''],
                    ['Ответственные за проведение съемок'],
                    ['Режиссер (редактор):', formData.director || ''],
                    ['Корреспондент:', formData.correspondent || ''],
                    ['Продюсер:', formData.producer || ''],
                    ['Оператор:', formData.operator || ''],
                    ['Видеоинженер:', formData.videoEngineer || ''],
                    ['Номер машины:', formData.carNumber || ''],
                    [''],
                    ['Дата подачи заявки:', formatDate(formData.applicationDate)],
                    ['Дата съемки:', formatDate(formData.shootingDate)],
                    ['Время съемки:', `${formData.startTime || ''} - ${formData.endTime || ''}`],
                    ['Продление:', formData.extension || ''],
                    ['Дата эфира:', formData.broadcastDate ? formatDate(formData.broadcastDate) : ''],
                    ['Дата и время сдачи материала в инжест:', formData.submissionDate ? formatDateTime(formData.submissionDate.split('T')[0], formData.submissionDate.split('T')[1]) : ''],
                    ['Инженер инжеста ФИО:', formData.engineerName || ''],
                    ['Подпись:', formData.signature || ''],
                    [''],
                    ['Оборудование - Основной комплект 1'],
                    ['Основной комплект', 'Дополнительное оборудование']
                ];
                
                if (formData.equipment && formData.equipment.length > 0) {
                    formData.equipment.forEach(eq => {
                        const mainText = eq.main ? `${eq.main}${eq.mainQuantity > 0 ? ` (${eq.mainQuantity} шт.)` : ''}` : '';
                        const additionalText = eq.additional ? `${eq.additional}${eq.additionalQuantity > 0 ? ` (${eq.additionalQuantity} шт.)` : ''}` : '';
                        sheetData.push([mainText, additionalText]);
                    });
                }
            }
            
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            ws['!cols'] = [{ wch: 40 }, { wch: 50 }];
            return ws;
        }
        
        // Функция для копирования полного стиля из одной ячейки в другую
        function copyFullCellStyle(sourceCell, targetCell) {
            try {
                const sourceStyle = sourceCell.style();
                if (sourceStyle && Object.keys(sourceStyle).length > 0) {
                    // Применяем полный объект стиля
                    targetCell.style(sourceStyle);
                    
                    // Дополнительно применяем отдельные свойства для гарантии
                    const styleProps = ['border', 'fontSize', 'fontFamily', 'bold', 'italic', 'fill', 
                                      'fontColor', 'horizontalAlignment', 'verticalAlignment', 
                                      'wrapText', 'numFmt', 'borderColor'];
                    
                    styleProps.forEach(prop => {
                        if (sourceStyle[prop] !== undefined) {
                            try {
                                targetCell.style(prop, sourceStyle[prop]);
                            } catch (e) {
                                // Игнорируем ошибки для отдельных свойств
                            }
                        }
                    });
                    
                    return true;
                }
            } catch (e) {
                console.warn('Ошибка при копировании стиля:', e);
            }
            return false;
        }
        
        // Функция для создания Excel файла с использованием xlsx-populate (лучше сохраняет стили из шаблона)
        async function createExcelWithTemplate(formData, applicationId, formatDate, formatDateTime, templateFileName, fileName, emailRecipient) {
            try {
                // Проверяем, доступна ли библиотека xlsx-populate
                if (typeof XlsxPopulate === 'undefined' || typeof XlsxPopulate.fromDataAsync !== 'function') {
                    throw new Error('xlsx-populate не загружен');
                }
                
                // Загружаем шаблон
                const response = await fetch(templateFileName);
                if (!response.ok) {
                    throw new Error('Шаблон не найден');
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = await XlsxPopulate.fromDataAsync(arrayBuffer);
                const sheet = workbook.sheet(0);
                
                // Заполняем данные в шаблоне, сохраняя все стили
                // Проходим по всем ячейкам и ищем нужные поля
                const maxRow = sheet.usedRange() ? sheet.usedRange().endCell().rowNumber() : 100;
                const maxCol = sheet.usedRange() ? sheet.usedRange().endCell().columnNumber() : 10;
                
                for (let row = 1; row <= maxRow; row++) {
                    for (let col = 1; col <= maxCol; col++) {
                        try {
                            const cell = sheet.cell(row, col);
                            const cellValue = cell.value();
                            
                            if (cellValue && typeof cellValue === 'string') {
                                // Функция для заполнения данных с полным сохранением стилей из шаблона
                                const fillCellWithStyle = (targetRow, targetCol, value) => {
                                    const targetCell = sheet.cell(targetRow, targetCol);
                                    
                                    // Сохраняем ПОЛНЫЙ стиль ячейки из шаблона ДО установки значения
                                    let fullStyle = null;
                                    try {
                                        fullStyle = targetCell.style();
                                    } catch (e) {
                                        // Если не удалось получить стиль, пробуем получить из соседних ячеек
                                    }
                                    
                                    // Если ячейка не имеет стиля, копируем из ячейки с меткой (левой ячейки)
                                    if (!fullStyle || Object.keys(fullStyle).length === 0) {
                                        try {
                                            const labelCell = sheet.cell(targetRow, targetCol - 1);
                                            const labelStyle = labelCell.style();
                                            if (labelStyle && Object.keys(labelStyle).length > 0) {
                                                // Копируем стиль из ячейки с меткой, но убираем жирность (значения обычно не жирные)
                                                fullStyle = JSON.parse(JSON.stringify(labelStyle));
                                                if (fullStyle.bold !== undefined) {
                                                    fullStyle.bold = false;
                                                }
                                            }
                                        } catch (e) {
                                            // Игнорируем ошибки
                                        }
                                    }
                                    
                                    // Если все еще нет стиля, пробуем получить из других соседних ячеек
                                    if (!fullStyle || Object.keys(fullStyle).length === 0) {
                                        try {
                                            // Пробуем верхнюю ячейку
                                            const topCell = sheet.cell(targetRow - 1, targetCol);
                                            const topStyle = topCell.style();
                                            if (topStyle && Object.keys(topStyle).length > 0) {
                                                fullStyle = JSON.parse(JSON.stringify(topStyle));
                                            }
                                        } catch (e) {
                                            // Игнорируем ошибки
                                        }
                                    }
                                    
                                    // Устанавливаем значение
                                    targetCell.value(value);
                                    
                                    // Восстанавливаем ПОЛНЫЙ стиль после установки значения
                                    if (fullStyle && Object.keys(fullStyle).length > 0) {
                                        // Используем функцию копирования стиля для надежности
                                        const sourceCell = fullStyle === targetCell.style() ? targetCell : 
                                                         (targetCol > 1 ? sheet.cell(targetRow, targetCol - 1) : 
                                                          (targetRow > 1 ? sheet.cell(targetRow - 1, targetCol) : targetCell));
                                        copyFullCellStyle(sourceCell, targetCell);
                                    }
                                };
                                
                                // Заполняем данные на основе содержимого ячейки
                                if (cellValue.includes('Название сюжета')) {
                                    fillCellWithStyle(row, col + 1, formData.storyTitle || '');
                                } else if (cellValue.includes('Аннотация')) {
                                    fillCellWithStyle(row, col + 1, formData.annotation || '');
                                } else if (cellValue.includes('Примечания')) {
                                    fillCellWithStyle(row, col + 1, formData.notes || '');
                                } else if (cellValue.includes('Аккредитация')) {
                                    fillCellWithStyle(row, col + 1, formData.accreditation === 'yes' ? 'ДА' : 'НЕТ');
                                } else if (cellValue.includes('Уточнения')) {
                                    fillCellWithStyle(row, col + 1, formData.clarifications || '');
                                } else if (cellValue.includes('Режиссер') || cellValue.includes('редактор')) {
                                    fillCellWithStyle(row, col + 1, formData.director || '');
                                } else if (cellValue.includes('Корреспондент')) {
                                    fillCellWithStyle(row, col + 1, formData.correspondent || '');
                                } else if (cellValue.includes('Продюсер')) {
                                    fillCellWithStyle(row, col + 1, formData.producer || '');
                                } else if (cellValue.includes('Оператор')) {
                                    fillCellWithStyle(row, col + 1, formData.operator || '');
                                } else if (cellValue.includes('Видеоинженер')) {
                                    fillCellWithStyle(row, col + 1, formData.videoEngineer || '');
                                } else if (cellValue.includes('Номер машины')) {
                                    fillCellWithStyle(row, col + 1, formData.carNumber || '');
                                } else if (cellValue.includes('Дата подачи заявки')) {
                                    fillCellWithStyle(row, col + 1, formatDate(formData.applicationDate));
                                } else if (cellValue.includes('Дата съемки')) {
                                    fillCellWithStyle(row, col + 1, formatDate(formData.shootingDate));
                                } else if (cellValue.includes('Время съемки')) {
                                    fillCellWithStyle(row, col + 1, `${formData.startTime || ''} - ${formData.endTime || ''}`);
                                } else if (cellValue.includes('Продление')) {
                                    fillCellWithStyle(row, col + 1, formData.extension || '');
                                } else if (cellValue.includes('Дата эфира')) {
                                    fillCellWithStyle(row, col + 1, formData.broadcastDate ? formatDate(formData.broadcastDate) : '');
                                } else if (cellValue.includes('Дата и время сдачи')) {
                                    fillCellWithStyle(row, col + 1, formData.submissionDate ? formatDateTime(formData.submissionDate.split('T')[0], formData.submissionDate.split('T')[1]) : '');
                                } else if (cellValue.includes('Инженер инжеста')) {
                                    fillCellWithStyle(row, col + 1, formData.engineerName || '');
                                } else if (cellValue.includes('Подпись')) {
                                    fillCellWithStyle(row, col + 1, formData.signature || '');
                                }
                            }
                        } catch (e) {
                            // Пропускаем ошибки при чтении ячеек
                            continue;
                        }
                    }
                }
                
                // Заполняем оборудование
                if (formData.equipment && formData.equipment.length > 0) {
                    let equipmentStartRow = null;
                    
                    // Ищем строку с заголовком оборудования
                    for (let row = 1; row <= maxRow; row++) {
                        for (let col = 1; col <= maxCol; col++) {
                            try {
                                const cell = sheet.cell(row, col);
                                const cellValue = cell.value();
                                if (cellValue && typeof cellValue === 'string' && 
                                    (cellValue.includes('Основной комплект') || cellValue.includes('Оборудование'))) {
                                    equipmentStartRow = row + 1;
                                    break;
                                }
                            } catch (e) {
                                continue;
                            }
                        }
                        if (equipmentStartRow) break;
                    }
                    
                    if (equipmentStartRow) {
                        // Находим первую строку с оборудованием в шаблоне для копирования стилей
                        let templateEquipmentRow = null;
                        for (let r = equipmentStartRow; r <= maxRow && !templateEquipmentRow; r++) {
                            const testCell = sheet.cell(r, 1);
                            const testValue = testCell.value();
                            if (testValue && typeof testValue === 'string' && testValue.trim() !== '') {
                                templateEquipmentRow = r;
                                break;
                            }
                        }
                        
                        // Если не нашли строку с данными, используем заголовок как шаблон
                        if (!templateEquipmentRow) {
                            templateEquipmentRow = equipmentStartRow - 1;
                        }
                        
                        formData.equipment.forEach((eq, index) => {
                            const row = equipmentStartRow + index;
                            const mainCell = sheet.cell(row, 1);
                            const additionalCell = sheet.cell(row, 2);
                            
                            // Копируем стили из строки-шаблона
                            if (templateEquipmentRow) {
                                try {
                                    const templateMainCell = sheet.cell(templateEquipmentRow, 1);
                                    const templateAdditionalCell = sheet.cell(templateEquipmentRow, 2);
                                    
                                    // Сохраняем ПОЛНЫЕ стили из шаблона
                                    let templateMainStyle = null;
                                    let templateAdditionalStyle = null;
                                    
                                    try {
                                        templateMainStyle = templateMainCell.style();
                                        templateAdditionalStyle = templateAdditionalCell.style();
                                    } catch (e) {
                                        // Если не удалось получить стили из этой строки, пробуем другие
                                    }
                                    
                                    // Если не получили стили, пробуем получить из заголовка
                                    let finalTemplateMainCell = templateMainCell;
                                    let finalTemplateAdditionalCell = templateAdditionalCell;
                                    
                                    if ((!templateMainStyle || Object.keys(templateMainStyle).length === 0) && equipmentStartRow > 1) {
                                        try {
                                            finalTemplateMainCell = sheet.cell(equipmentStartRow - 1, 1);
                                            finalTemplateAdditionalCell = sheet.cell(equipmentStartRow - 1, 2);
                                        } catch (e) {
                                            // Игнорируем ошибки
                                        }
                                    }
                                    
                                    // Устанавливаем значения
                                    mainCell.value(eq.main ? `${eq.main}${eq.mainQuantity > 0 ? ` (${eq.mainQuantity} шт.)` : ''}` : '');
                                    additionalCell.value(eq.additional ? `${eq.additional}${eq.additionalQuantity > 0 ? ` (${eq.additionalQuantity} шт.)` : ''}` : '');
                                    
                                    // Применяем ПОЛНЫЕ стили из шаблона используя функцию копирования
                                    if (finalTemplateMainCell) {
                                        copyFullCellStyle(finalTemplateMainCell, mainCell);
                                    }
                                    
                                    if (finalTemplateAdditionalCell) {
                                        copyFullCellStyle(finalTemplateAdditionalCell, additionalCell);
                                    }
                                } catch (e) {
                                    console.warn('Ошибка при копировании стилей оборудования:', e);
                                    // Если не удалось скопировать стили, просто устанавливаем значения
                                    mainCell.value(eq.main ? `${eq.main}${eq.mainQuantity > 0 ? ` (${eq.mainQuantity} шт.)` : ''}` : '');
                                    additionalCell.value(eq.additional ? `${eq.additional}${eq.additionalQuantity > 0 ? ` (${eq.additionalQuantity} шт.)` : ''}` : '');
                                }
                            } else {
                                // Если нет шаблона, просто устанавливаем значения
                                mainCell.value(eq.main ? `${eq.main}${eq.mainQuantity > 0 ? ` (${eq.mainQuantity} шт.)` : ''}` : '');
                                additionalCell.value(eq.additional ? `${eq.additional}${eq.additionalQuantity > 0 ? ` (${eq.additionalQuantity} шт.)` : ''}` : '');
                            }
                        });
                    }
                }
                
                // Генерируем файл (сохраняет все стили из шаблона)
                const blob = await workbook.outputAsync();
                return blob;
            } catch (error) {
                console.warn('Ошибка при использовании xlsx-populate, используем SheetJS:', error);
                return null;
            }
        }
        
        // Функция для создания Excel файла на основе шаблона с сохранением форматирования
        async function createExcelDocumentAndSend(formData, applicationId, emailRecipient = 'pendeho098rus@yandex.ru') {
            try {
                const formatDate = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString + 'T00:00:00');
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}.${month}.${year}`;
                };
                
                const formatDateTime = (dateString, timeString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString + (timeString ? 'T' + timeString : 'T00:00:00'));
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    const hours = timeString ? String(date.getHours()).padStart(2, '0') : '00';
                    const minutes = timeString ? String(date.getMinutes()).padStart(2, '0') : '00';
                    return timeString ? `${day}.${month}.${year} ${hours}:${minutes}` : `${day}.${month}.${year}`;
                };
                
                let fileName = '';
                let templateFileName = '';
                
                // Определяем имя шаблона
                if (formData.contractor === 'figaro') {
                    templateFileName = 'Заявка ФИГАРО.xlsx';
                    fileName = `Заявка_ФИГАРО_${formatDate(formData.shootingDate)}_${(formData.storyTitle || applicationId.substring(0, 8)).substring(0, 20).replace(/[<>:"/\\|?*]/g, '_')}.xlsx`;
                } else if (formData.contractor === 'ttk') {
                    templateFileName = 'Заявка ТТК.xlsx';
                    fileName = `Заявка_ТТК_${formatDate(formData.shootingDate)}_${(formData.storyTitle || applicationId.substring(0, 8)).substring(0, 20).replace(/[<>:"/\\|?*]/g, '_')}.xlsx`;
                } else {
                    throw new Error('Неизвестный тип подрядчика');
                }
                
                // Сначала пытаемся использовать xlsx-populate для лучшего сохранения стилей из шаблона
                let blob;
                if (typeof XlsxPopulate !== 'undefined') {
                    try {
                        blob = await createExcelWithTemplate(formData, applicationId, formatDate, formatDateTime, templateFileName, fileName, emailRecipient);
                        if (blob) {
                            // ExcelJS успешно создал файл, используем его
                            // Скачиваем файл
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = fileName.replace(/[<>:"/\\|?*]/g, '_');
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                            
                            // Отправляем на почту
                            const userEmail = authManager ? authManager.getUserEmail() : null;
                            const apiUrl = (typeof window !== 'undefined' ? window.location.origin : '') + '/api/send-email';
                            
                            if (typeof emailService !== 'undefined' && typeof emailService.sendViaGoogleAppsScript === 'function' && emailService.googleAppsScriptUrl) {
                                emailService.sendViaGoogleAppsScript(blob, formData, applicationId, emailRecipient)
                                    .then(result => {
                                        if (result.success) {
                                            const contractorName = formData.contractor === 'figaro' ? 'ФИГАРО' : 'ТТК';
                                            alert(`Заявка ${contractorName} успешно создана и отправлена на email с вложением Excel файла!\n\nНомер заявки: ${applicationId.substring(0, 8)}\nПисьмо отправлено на: ${emailRecipient}`);
                                        } else {
                                            tryServerlessOrEmailJSForExcel(formData, applicationId, formatDate, emailRecipient, userEmail, apiUrl, blob);
                                        }
                                    })
                                    .catch(error => {
                                        console.warn('Google Apps Script недоступен:', error);
                                        tryServerlessOrEmailJSForExcel(formData, applicationId, formatDate, emailRecipient, userEmail, apiUrl, blob);
                                    });
                            } else {
                                tryServerlessOrEmailJSForExcel(formData, applicationId, formatDate, emailRecipient, userEmail, apiUrl, blob);
                            }
                            return; // Выходим, так как xlsx-populate успешно создал файл
                        }
                    } catch (error) {
                        console.warn('Ошибка при использовании xlsx-populate, переходим на SheetJS:', error);
                    }
                }
                
                // Если ExcelJS не доступен или не сработал, используем SheetJS
                let workbook;
                let templateLoaded = false;
                try {
                    const response = await fetch(templateFileName);
                    if (response.ok) {
                        const arrayBuffer = await response.arrayBuffer();
                        // Читаем шаблон с максимальным сохранением стилей
                        workbook = XLSX.read(arrayBuffer, {
                            type: 'array', 
                            cellStyles: true, 
                            cellDates: true,
                            cellNF: true,
                            cellHTML: false,
                            sheetStubs: true,
                            dense: false
                        });
                        templateLoaded = true;
                    } else {
                        throw new Error('Шаблон не найден');
                    }
                } catch (error) {
                    console.warn('Не удалось загрузить шаблон, создаем новый файл:', error);
                    workbook = XLSX.utils.book_new();
                }
                
                // Получаем первый лист или создаем новый
                let ws = workbook.Sheets[workbook.SheetNames[0]] || XLSX.utils.aoa_to_sheet([[]]);
                
                // Если шаблон загружен, заполняем его данными с сохранением стилей
                if (templateLoaded && workbook.SheetNames.length > 0 && workbook.Sheets[workbook.SheetNames[0]]) {
                    // Заполняем данные в шаблоне, сохраняя все стили
                    fillTemplateData(ws, formData, formatDate, formatDateTime);
                    
                    // Сохраняем все настройки листа из шаблона
                    if (workbook.Sheets[workbook.SheetNames[0]]['!merges']) {
                        ws['!merges'] = workbook.Sheets[workbook.SheetNames[0]]['!merges'];
                    }
                    if (workbook.Sheets[workbook.SheetNames[0]]['!cols']) {
                        ws['!cols'] = workbook.Sheets[workbook.SheetNames[0]]['!cols'];
                    }
                    if (workbook.Sheets[workbook.SheetNames[0]]['!rows']) {
                        ws['!rows'] = workbook.Sheets[workbook.SheetNames[0]]['!rows'];
                    }
                    if (workbook.Sheets[workbook.SheetNames[0]]['!margins']) {
                        ws['!margins'] = workbook.Sheets[workbook.SheetNames[0]]['!margins'];
                    }
                } else {
                    // Создаем новый файл с форматированием
                    ws = createFormattedSheet(formData, formatDate, formatDateTime);
                    XLSX.utils.book_append_sheet(workbook, ws, 'Заявка');
                }
                
                // Генерируем Excel файл с максимальным сохранением стилей
                const excelBuffer = XLSX.write(workbook, { 
                    type: 'array', 
                    bookType: 'xlsx',
                    cellStyles: true,
                    cellNF: true,
                    bookSST: false,
                    compression: true
                });
                blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                
                // Скачиваем файл
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName.replace(/[<>:"/\\|?*]/g, '_');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Попытка автоматической отправки через Google Apps Script, Serverless функцию или EmailJS
                const userEmail = authManager ? authManager.getUserEmail() : null;
                const apiUrl = (typeof window !== 'undefined' ? window.location.origin : '') + '/api/send-email';
                
                // Приоритет 1: Google Apps Script (бесплатно, поддерживает вложения) ⭐ РЕКОМЕНДУЕТСЯ
                if (typeof emailService !== 'undefined' && typeof emailService.sendViaGoogleAppsScript === 'function' && emailService.googleAppsScriptUrl) {
                    emailService.sendViaGoogleAppsScript(blob, formData, applicationId, emailRecipient)
                        .then(result => {
                            if (result.success) {
                                const contractorName = formData.contractor === 'figaro' ? 'ФИГАРО' : 'ТТК';
                                alert(`Заявка ${contractorName} успешно создана и отправлена на email с вложением Excel файла!\n\nНомер заявки: ${applicationId.substring(0, 8)}\nПисьмо отправлено на: ${emailRecipient}`);
                            } else {
                                // Если Google Apps Script не работает, пробуем serverless функцию
                                tryServerlessOrEmailJSForExcel(formData, applicationId, formatDate, emailRecipient, userEmail, apiUrl, blob);
                            }
                        })
                        .catch(error => {
                            console.warn('Google Apps Script недоступен, пробуем serverless функцию:', error);
                            tryServerlessOrEmailJSForExcel(formData, applicationId, formatDate, emailRecipient, userEmail, apiUrl, blob);
                        });
                } else {
                    // Если Google Apps Script не настроен, пробуем serverless функцию
                    tryServerlessOrEmailJSForExcel(formData, applicationId, formatDate, emailRecipient, userEmail, apiUrl, blob);
                }
            } catch (error) {
                console.error('Ошибка при создании Excel документа:', error);
                alert('Ошибка при создании Excel документа: ' + error.message);
            }
        }
        
        // Функция для попытки отправки Excel через Serverless функцию, EmailJS или ручная отправка
        function tryServerlessOrEmailJSForExcel(formData, applicationId, formatDate, emailRecipient, userEmail, apiUrl, blob) {
            // Приоритет 2: Serverless функция (SMTP) - поддерживает вложения
            if (typeof emailService !== 'undefined' && typeof emailService.sendApplicationEmailWithAttachment === 'function') {
                emailService.sendApplicationEmailWithAttachment(blob, formData, applicationId, emailRecipient, apiUrl)
                    .then(result => {
                        if (result.success) {
                            const contractorName = formData.contractor === 'figaro' ? 'ФИГАРО' : 'ТТК';
                            alert(`Заявка ${contractorName} успешно создана и отправлена на email с вложением Excel файла!\n\nНомер заявки: ${applicationId.substring(0, 8)}\nПисьмо отправлено на: ${emailRecipient}`);
                        } else {
                            // Если serverless не работает, пробуем EmailJS или ручную отправку
                            tryEmailJSOrManualForExcel(formData, applicationId, formatDate, emailRecipient, userEmail);
                        }
                    })
                    .catch(error => {
                        console.warn('Serverless функция недоступна, пробуем EmailJS:', error);
                        tryEmailJSOrManualForExcel(formData, applicationId, formatDate, emailRecipient, userEmail);
                    });
            } else {
                // Если serverless функция недоступна, пробуем EmailJS или ручную отправку
                tryEmailJSOrManualForExcel(formData, applicationId, formatDate, emailRecipient, userEmail);
            }
        }
        
        // Функция для попытки отправки Excel через EmailJS или ручная отправка
        function tryEmailJSOrManualForExcel(formData, applicationId, formatDate, emailRecipient, userEmail) {
            // Для Excel файлов всегда предлагаем ручную отправку, так как EmailJS не поддерживает вложения
            offerManualEmailSendingForExcel(formData, applicationId, formatDate, emailRecipient);
        }
        
        // Функция для предложения ручной отправки Excel файла
        function offerManualEmailSendingForExcel(formData, applicationId, formatDate, emailRecipient = 'pendeho098rus@yandex.ru') {
            setTimeout(() => {
                const contractorName = formData.contractor === 'figaro' ? 'ФИГАРО' : 'ТТК';
                const subjectText = formData.contractor === 'figaro' ? 'ФИГАРО' : 'ТТК';
                
                // Определяем имя файла
                let fileName = '';
                if (formData.contractor === 'figaro') {
                    fileName = `Заявка_ФИГАРО_${formatDate(formData.shootingDate)}_${(formData.storyTitle || applicationId.substring(0, 8)).substring(0, 20).replace(/[<>:"/\\|?*]/g, '_')}.xlsx`;
                } else if (formData.contractor === 'ttk') {
                    fileName = `Заявка_ТТК_${formatDate(formData.shootingDate)}_${(formData.storyTitle || applicationId.substring(0, 8)).substring(0, 20).replace(/[<>:"/\\|?*]/g, '_')}.xlsx`;
                }
                
                // Сохраняем данные для модального окна
                currentEmailData = {
                    formData: formData,
                    applicationId: applicationId,
                    formatDate: formatDate,
                    emailRecipient: emailRecipient,
                    contractorName: contractorName,
                    subjectText: subjectText,
                    fileName: fileName
                };
                
                // Обновляем информацию в модальном окне
                document.getElementById('emailFileName').textContent = fileName;
                document.getElementById('emailFilePath').textContent = getDownloadsPath();
                
                // Показываем модальное окно
                showEmailModal();
            }, 500);
        }
        
        function createWordDocumentAndSend(formData, applicationId, emailRecipient = 'pendeho098rus@yandex.ru') {
            try {
                const formatDate = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString + 'T00:00:00');
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}.${month}.${year}`;
                };
                
                let htmlContent = '';
                let fileName = '';
                let documentTitle = '';
                
                // Формируем содержимое Word документа в зависимости от типа заявки
                if (formData.contractor === 'producer') {
                    // Заявка продюсерам
                    const correspondentText = formData.correspondentText || formData.correspondent || '-';
                    const directorText = formData.directorText || formData.director || '-';
                    
                    documentTitle = 'Заявка продюсерам';
                    htmlContent = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${documentTitle}</title>
    <style>
        body { font-family: 'Times New Roman', serif; font-size: 12pt; margin: 2cm; line-height: 1.5; }
        h1 { font-size: 16pt; font-weight: bold; text-align: center; margin-bottom: 20pt; }
        h2 { text-align: center; font-size: 14pt; margin-bottom: 20pt; }
        table { width: 100%; border-collapse: collapse; margin-top: 10pt; }
        td { padding: 6pt; vertical-align: top; }
        .label-cell { font-weight: bold; width: 30%; }
    </style>
</head>
<body>
    <h1>${documentTitle}</h1>
    <h2>Программа "Доброе утро"</h2>
    <table>
        <tr><td class="label-cell">Название сюжета:</td><td>${formData.storyTitle || '-'}</td></tr>
        <tr><td class="label-cell">Краткое содержание сюжета:</td><td>${(formData.summary || '').replace(/\n/g, '<br>')}</td></tr>
        ${formData.heroes ? `<tr><td class="label-cell">Герои:</td><td>${formData.heroes.replace(/\n/g, '<br>')}</td></tr>` : ''}
        <tr><td class="label-cell">Дата съемки:</td><td>${formatDate(formData.shootingDate)}</td></tr>
        <tr><td class="label-cell">Время съемки:</td><td>${formData.startTime || '-'} - ${formData.endTime || '-'}</td></tr>
        <tr><td class="label-cell">Корреспондент:</td><td>${correspondentText}</td></tr>
        <tr><td class="label-cell">Контакты корреспондента:</td><td>${formData.correspondentContacts || '-'}</td></tr>
        <tr><td class="label-cell">Редактор:</td><td>${directorText}</td></tr>
        <tr><td class="label-cell">Дата подачи заявки:</td><td>${formatDate(formData.applicationDate)}</td></tr>
    </table>
    <div style="margin-top: 30pt; font-size: 10pt; color: #666;"><p>Номер заявки: ${applicationId.substring(0, 8)}</p></div>
</body>
</html>`;
                    fileName = `Заявка_продюсерам_${formatDate(formData.shootingDate)}_${(formData.storyTitle || applicationId.substring(0, 8)).substring(0, 20)}.doc`;
                } else if (formData.contractor === 'figaro') {
                    // Заявка ФИГАРО
                    documentTitle = 'Заявка на видеосъемку - ВЕК XXL (ФИГАРО)';
                    // Форматирование оборудования в формате, соответствующем Excel (два столбца)
                    const equipmentText = formData.equipment && formData.equipment.length > 0 
                        ? formData.equipment.map(eq => {
                            let result = '';
                            // Основное оборудование
                            if (eq.main) {
                                result = eq.main;
                                if (eq.mainQuantity && eq.mainQuantity > 0) {
                                    result += ` (${eq.mainQuantity} шт.)`;
                                }
                            }
                            // Дополнительное оборудование
                            if (eq.additional) {
                                if (result) result += '<br>';
                                result += `Дополнительно: ${eq.additional}`;
                                if (eq.additionalQuantity && eq.additionalQuantity > 0) {
                                    result += ` (${eq.additionalQuantity} шт.)`;
                                }
                            }
                            return result || '-';
                        }).filter(eq => eq !== '-').join('<br><br>')
                        : '-';
                    
                    htmlContent = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${documentTitle}</title>
    <style>
        body { font-family: 'Times New Roman', serif; font-size: 12pt; margin: 2cm; line-height: 1.5; }
        h1 { font-size: 16pt; font-weight: bold; text-align: center; margin-bottom: 20pt; }
        table { width: 100%; border-collapse: collapse; margin-top: 10pt; }
        td { padding: 6pt; vertical-align: top; border: 1px solid #000; }
        .label-cell { font-weight: bold; width: 30%; background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>${documentTitle}</h1>
    <h2 style="text-align: center; font-size: 14pt; margin-bottom: 20pt;">Программа "Доброе утро"</h2>
    <table>
        <tr><td class="label-cell">Название сюжета:</td><td>${formData.storyTitle || '-'}</td></tr>
        <tr><td class="label-cell">Аннотация:</td><td>${(formData.annotation || '').replace(/\n/g, '<br>')}</td></tr>
        <tr><td class="label-cell">Примечания:</td><td>${(formData.notes || '').replace(/\n/g, '<br>')}</td></tr>
        <tr><td class="label-cell">Аккредитация:</td><td>${formData.accreditation || '-'}</td></tr>
        <tr><td class="label-cell">Режиссер (редактор):</td><td>${formData.director || '-'}</td></tr>
        <tr><td class="label-cell">Корреспондент:</td><td>${formData.correspondent || '-'}</td></tr>
        <tr><td class="label-cell">Продюсер:</td><td>${formData.producer || '-'}</td></tr>
        <tr><td class="label-cell">Оператор:</td><td>${formData.operator || '-'}</td></tr>
        <tr><td class="label-cell">Видеоинженер:</td><td>${formData.videoEngineer || '-'}</td></tr>
        <tr><td class="label-cell">Дата подачи заявки:</td><td>${formatDate(formData.applicationDate)}</td></tr>
        <tr><td class="label-cell">Дата съемки:</td><td>${formatDate(formData.shootingDate)}</td></tr>
        <tr><td class="label-cell">Время съемки:</td><td>${formData.startTime || '-'} - ${formData.endTime || '-'}</td></tr>
        ${formData.broadcastDate ? `<tr><td class="label-cell">Дата эфира:</td><td>${formatDate(formData.broadcastDate)}</td></tr>` : ''}
        <tr><td class="label-cell">Оборудование:</td><td>${equipmentText}</td></tr>
    </table>
    <div style="margin-top: 30pt; font-size: 10pt; color: #666;"><p>Номер заявки: ${applicationId.substring(0, 8)}</p></div>
</body>
</html>`;
                    fileName = `Заявка_ФИГАРО_${formatDate(formData.shootingDate)}_${(formData.storyTitle || applicationId.substring(0, 8)).substring(0, 20)}.doc`;
                } else if (formData.contractor === 'ttk') {
                    // Заявка ТТК
                    documentTitle = 'Заявка на видеосъемку - Технологический центр ТВ (ТТК)';
                    // Форматирование оборудования в формате, соответствующем Excel (два столбца)
                    const equipmentText = formData.equipment && formData.equipment.length > 0 
                        ? formData.equipment.map(eq => {
                            let result = '';
                            // Основное оборудование
                            if (eq.main) {
                                result = eq.main;
                                if (eq.mainQuantity && eq.mainQuantity > 0) {
                                    result += ` (${eq.mainQuantity} шт.)`;
                                }
                            }
                            // Дополнительное оборудование
                            if (eq.additional) {
                                if (result) result += '<br>';
                                result += `Дополнительно: ${eq.additional}`;
                                if (eq.additionalQuantity && eq.additionalQuantity > 0) {
                                    result += ` (${eq.additionalQuantity} шт.)`;
                                }
                            }
                            return result || '-';
                        }).filter(eq => eq !== '-').join('<br><br>')
                        : '-';
                    
                    htmlContent = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${documentTitle}</title>
    <style>
        body { font-family: 'Times New Roman', serif; font-size: 12pt; margin: 2cm; line-height: 1.5; }
        h1 { font-size: 16pt; font-weight: bold; text-align: center; margin-bottom: 20pt; }
        table { width: 100%; border-collapse: collapse; margin-top: 10pt; }
        td { padding: 6pt; vertical-align: top; border: 1px solid #000; }
        .label-cell { font-weight: bold; width: 30%; background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>${documentTitle}</h1>
    <h2 style="text-align: center; font-size: 14pt; margin-bottom: 20pt;">Программа "Доброе утро"</h2>
    <table>
        <tr><td class="label-cell">Название сюжета:</td><td>${formData.storyTitle || '-'}</td></tr>
        <tr><td class="label-cell">Аннотация:</td><td>${(formData.annotation || '').replace(/\n/g, '<br>')}</td></tr>
        <tr><td class="label-cell">Примечания:</td><td>${(formData.notes || '').replace(/\n/g, '<br>')}</td></tr>
        <tr><td class="label-cell">Аккредитация:</td><td>${formData.accreditation || '-'}</td></tr>
        <tr><td class="label-cell">Уточнения:</td><td>${(formData.clarifications || '').replace(/\n/g, '<br>')}</td></tr>
        <tr><td class="label-cell">Режиссер (редактор):</td><td>${formData.director || '-'}</td></tr>
        <tr><td class="label-cell">Корреспондент:</td><td>${formData.correspondent || '-'}</td></tr>
        <tr><td class="label-cell">Продюсер:</td><td>${formData.producer || '-'}</td></tr>
        <tr><td class="label-cell">Оператор:</td><td>${formData.operator || '-'}</td></tr>
        <tr><td class="label-cell">Видеоинженер:</td><td>${formData.videoEngineer || '-'}</td></tr>
        <tr><td class="label-cell">Номер машины:</td><td>${formData.carNumber || '-'}</td></tr>
        <tr><td class="label-cell">Дата подачи заявки:</td><td>${formatDate(formData.applicationDate)}</td></tr>
        <tr><td class="label-cell">Дата съемки:</td><td>${formatDate(formData.shootingDate)}</td></tr>
        <tr><td class="label-cell">Время съемки:</td><td>${formData.startTime || '-'} - ${formData.endTime || '-'}</td></tr>
        <tr><td class="label-cell">Продление:</td><td>${formData.extension || '-'}</td></tr>
        ${formData.broadcastDate ? `<tr><td class="label-cell">Дата эфира:</td><td>${formatDate(formData.broadcastDate)}</td></tr>` : ''}
        ${formData.submissionDate ? `<tr><td class="label-cell">Дата сдачи:</td><td>${formatDate(formData.submissionDate)}</td></tr>` : ''}
        <tr><td class="label-cell">Оборудование:</td><td>${equipmentText}</td></tr>
    </table>
    <div style="margin-top: 30pt; font-size: 10pt; color: #666;"><p>Номер заявки: ${applicationId.substring(0, 8)}</p></div>
</body>
</html>`;
                    fileName = `Заявка_ТТК_${formatDate(formData.shootingDate)}_${(formData.storyTitle || applicationId.substring(0, 8)).substring(0, 20)}.doc`;
                }
                
                // Создаем Blob с HTML содержимым
                const blob = new Blob(['\ufeff', htmlContent], { type: 'application/msword' });
                
                // Скачиваем файл
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName.replace(/[<>:"/\\|?*]/g, '_');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Попытка автоматической отправки через Google Apps Script, Serverless функцию или EmailJS
                const userEmail = authManager ? authManager.getUserEmail() : null;
                const apiUrl = (typeof window !== 'undefined' ? window.location.origin : '') + '/api/send-email';
                
                // Приоритет 1: Google Apps Script (бесплатно, поддерживает вложения) ⭐ РЕКОМЕНДУЕТСЯ
                if (typeof emailService !== 'undefined' && typeof emailService.sendViaGoogleAppsScript === 'function' && emailService.googleAppsScriptUrl) {
                    emailService.sendViaGoogleAppsScript(blob, formData, applicationId, emailRecipient)
                        .then(result => {
                            if (result.success) {
                                const contractorName = formData.contractor === 'figaro' ? 'ФИГАРО' : 
                                                      formData.contractor === 'ttk' ? 'ТТК' : 'продюсерам';
                                alert(`Заявка ${contractorName} успешно создана и отправлена на email с вложением Word файла!\n\nНомер заявки: ${applicationId.substring(0, 8)}\nПисьмо отправлено на: ${emailRecipient}`);
                            } else {
                                // Если Google Apps Script не работает, пробуем serverless функцию
                                tryServerlessOrEmailJS(formData, applicationId, formatDate, emailRecipient, userEmail, apiUrl, blob);
                            }
                        })
                        .catch(error => {
                            console.warn('Google Apps Script недоступен, пробуем serverless функцию:', error);
                            tryServerlessOrEmailJS(formData, applicationId, formatDate, emailRecipient, userEmail, apiUrl, blob);
                        });
                } else {
                    // Если Google Apps Script не настроен, пробуем serverless функцию
                    tryServerlessOrEmailJS(formData, applicationId, formatDate, emailRecipient, userEmail, apiUrl, blob);
                }
            } catch (error) {
                console.error('Ошибка при создании Word документа:', error);
                alert('Ошибка при создании Word документа: ' + error.message);
            }
        }
        
        // Функция создания Word документа для заявки продюсерам (для обратной совместимости)
        function createAndSendWordDocument(formData, applicationId) {
            // Вызываем универсальную функцию
            createWordDocumentAndSend(formData, applicationId);
        }
        
        // Функция для попытки отправки через Serverless функцию, EmailJS или ручная отправка
        function tryServerlessOrEmailJS(formData, applicationId, formatDate, emailRecipient, userEmail, apiUrl, blob) {
            // Приоритет 2: Serverless функция (SMTP) - поддерживает вложения
            if (typeof emailService !== 'undefined' && typeof emailService.sendApplicationEmailWithAttachment === 'function') {
                emailService.sendApplicationEmailWithAttachment(blob, formData, applicationId, emailRecipient, apiUrl)
                    .then(result => {
                        if (result.success) {
                            const contractorName = formData.contractor === 'figaro' ? 'ФИГАРО' : 
                                                  formData.contractor === 'ttk' ? 'ТТК' : 'продюсерам';
                            alert(`Заявка ${contractorName} успешно создана и отправлена на email с вложением Word файла!\n\nНомер заявки: ${applicationId.substring(0, 8)}\nПисьмо отправлено на: ${emailRecipient}`);
                        } else {
                            // Если serverless не работает, пробуем EmailJS
                            tryEmailJSOrManual(formData, applicationId, formatDate, emailRecipient, userEmail);
                        }
                    })
                    .catch(error => {
                        console.warn('Serverless функция недоступна, пробуем EmailJS:', error);
                        tryEmailJSOrManual(formData, applicationId, formatDate, emailRecipient, userEmail);
                    });
            } else {
                // Если serverless функция недоступна, пробуем EmailJS
                tryEmailJSOrManual(formData, applicationId, formatDate, emailRecipient, userEmail);
            }
        }
        
        // Функция для попытки отправки через EmailJS или ручная отправка
        function tryEmailJSOrManual(formData, applicationId, formatDate, emailRecipient, userEmail) {
            if (typeof emailService !== 'undefined' && typeof authManager !== 'undefined') {
                emailService.initEmailJS();
                
                if (userEmail && emailService.enabled) {
                    // Пытаемся использовать EmailJS
                    emailService.sendApplicationEmail(formData, applicationId, userEmail, emailRecipient)
                        .then(result => {
                            if (result.success) {
                                const contractorName = formData.contractor === 'figaro' ? 'ФИГАРО' : 
                                                      formData.contractor === 'ttk' ? 'ТТК' : 'продюсерам';
                                alert(`Заявка ${contractorName} успешно создана и отправлена на email!\n\nНомер заявки: ${applicationId.substring(0, 8)}\nПисьмо отправлено на: ${emailRecipient}\n\nПримечание: Word файл скачан отдельно. Для отправки с вложением используйте Serverless функцию (см. НАСТРОЙКА_SERVERLESS_SMTP.md)`);
                            } else {
                                offerManualEmailSending(formData, applicationId, formatDate, emailRecipient);
                            }
                        })
                        .catch(() => {
                            offerManualEmailSending(formData, applicationId, formatDate, emailRecipient);
                        });
                } else {
                    offerManualEmailSending(formData, applicationId, formatDate, emailRecipient);
                }
            } else {
                offerManualEmailSending(formData, applicationId, formatDate, emailRecipient);
            }
        }
        
        // Глобальные переменные для модального окна
        let currentEmailData = null;
        
        // Функция для предложения ручной отправки email (улучшенная версия)
        function offerManualEmailSending(formData, applicationId, formatDate, emailRecipient = 'pendeho098rus@yandex.ru') {
            setTimeout(() => {
                const contractorName = formData.contractor === 'figaro' ? 'ФИГАРО' : 
                                      formData.contractor === 'ttk' ? 'ТТК' : 'продюсерам';
                const subjectText = formData.contractor === 'producer' ? 'продюсерам' : 
                                   formData.contractor === 'figaro' ? 'ФИГАРО' : 'ТТК';
                
                // Определяем имя файла
                let fileName = '';
                if (formData.contractor === 'producer') {
                    fileName = `Заявка_продюсерам_${formatDate(formData.shootingDate)}_${(formData.storyTitle || applicationId.substring(0, 8)).substring(0, 20).replace(/[<>:"/\\|?*]/g, '_')}.doc`;
                } else if (formData.contractor === 'figaro') {
                    fileName = `Заявка_ФИГАРО_${formatDate(formData.shootingDate)}_${(formData.storyTitle || applicationId.substring(0, 8)).substring(0, 20).replace(/[<>:"/\\|?*]/g, '_')}.doc`;
                } else if (formData.contractor === 'ttk') {
                    fileName = `Заявка_ТТК_${formatDate(formData.shootingDate)}_${(formData.storyTitle || applicationId.substring(0, 8)).substring(0, 20).replace(/[<>:"/\\|?*]/g, '_')}.doc`;
                }
                
                // Сохраняем данные для модального окна
                currentEmailData = {
                    formData: formData,
                    applicationId: applicationId,
                    formatDate: formatDate,
                    emailRecipient: emailRecipient,
                    contractorName: contractorName,
                    subjectText: subjectText,
                    fileName: fileName
                };
                
                // Обновляем информацию в модальном окне
                document.getElementById('emailFileName').textContent = fileName;
                document.getElementById('emailFilePath').textContent = getDownloadsPath();
                
                // Показываем модальное окно
                showEmailModal();
            }, 500);
        }
        
        // Функция для показа модального окна
        function showEmailModal() {
            const modal = document.getElementById('emailModalOverlay');
            modal.classList.add('show');
        }
        
        // Функция для закрытия модального окна
        function closeEmailModal() {
            const modal = document.getElementById('emailModalOverlay');
            modal.classList.remove('show');
            currentEmailData = null;
        }
        
        // Функция для определения пути к папке Загрузки
        function getDownloadsPath() {
            const userAgent = navigator.userAgent.toLowerCase();
            if (userAgent.includes('windows')) {
                return 'C:\\Users\\[Ваше имя]\\Загрузки\\';
            } else if (userAgent.includes('mac')) {
                return '/Users/[Ваше имя]/Downloads/';
            } else if (userAgent.includes('linux')) {
                return '~/Downloads/';
            } else {
                return 'Папка "Загрузки"';
            }
        }
        
        // Функция для открытия почтового клиента из модального окна
        function openEmailClientFromModal() {
            if (!currentEmailData) return;
            
            const { formData, applicationId, formatDate, emailRecipient, subjectText, fileName } = currentEmailData;
            
            // Определяем тип файла (Word или Excel)
            const fileType = fileName && fileName.endsWith('.xlsx') ? 'Excel' : 'Word';
            const fileExtension = fileName && fileName.endsWith('.xlsx') ? 'Excel файл' : 'Word файл';
            
            // Формируем улучшенный текст письма
            let emailBody = `Добрый день!

Во вложении заявка ${subjectText}.

Номер заявки: ${applicationId.substring(0, 8)}
Дата съемки: ${formatDate(formData.shootingDate)}
Название сюжета: ${formData.storyTitle || 'Новая заявка'}

Пожалуйста, прикрепите ${fileExtension} к этому письму.
Файл уже скачан в папку "Загрузки".

С уважением,
Система заявок на видеосъемку`;
            
            const subject = encodeURIComponent(`Заявка ${subjectText}: ${formData.storyTitle || 'Новая заявка'}`);
            const body = encodeURIComponent(emailBody);
            
            window.location.href = `mailto:${emailRecipient}?subject=${subject}&body=${body}`;
            
            // Показываем подсказку через небольшую задержку
            setTimeout(() => {
                alert(`💡 Подсказка:\n\n1. В открывшемся почтовом клиенте нажмите "Прикрепить файл" или "Вложения"\n2. Найдите ${fileExtension} в папке "Загрузки"\n3. Выберите файл и прикрепите его\n4. Нажмите "Отправить"`);
            }, 500);
        }
        
        // Функция для показа информации о папке Загрузки
        function showDownloadsFolderInfo() {
            const path = getDownloadsPath();
            const fileName = currentEmailData ? currentEmailData.fileName : 'файл';
            
            alert(`📁 Информация о файле:\n\nИмя файла: ${fileName}\n\nРасположение: ${path}\n\n💡 Как найти файл:\n1. Откройте Проводник (Windows) или Finder (Mac)\n2. Перейдите в папку "Загрузки" (Downloads)\n3. Найдите файл по имени\n4. Прикрепите его к письму`);
        }
        
        // Закрытие модального окна по клику вне его
        document.addEventListener('DOMContentLoaded', function() {
            const modalOverlay = document.getElementById('emailModalOverlay');
            if (modalOverlay) {
                modalOverlay.addEventListener('click', function(e) {
                    if (e.target === modalOverlay) {
                        closeEmailModal();
                    }
                });
            }
            
            // Закрытие по Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('emailModalOverlay');
                    if (modal && modal.classList.contains('show')) {
                        closeEmailModal();
                    }
                }
            });
        });
        
        // Функция для сбора данных об оборудовании из формы
        function collectEquipmentData(contractorType) {
            const equipmentTable = contractorType === 'figaro' 
                ? document.querySelector('#formFigaro .equipment-table')
                : document.querySelector('#formTTK .equipment-table');
            
            if (!equipmentTable) return [];
            
            const rows = equipmentTable.querySelectorAll('tbody tr');
            const equipment = [];
            
            rows.forEach(row => {
                const mainCells = row.querySelectorAll('td');
                if (mainCells.length >= 2) {
                    const mainEq = mainCells[0]?.textContent?.trim() || '';
                    const additionalEq = mainCells[1]?.textContent?.trim() || '';
                    const additionalQty = mainCells[2]?.querySelector('select')?.value || '0';
                    
                    // Извлекаем количество из основного оборудования
                    const mainInput = mainCells[0]?.querySelector('input[type="number"]');
                    const mainQty = mainInput?.value || '0';
                    
                    // Убираем "шт" и количество из текста
                    const mainEqName = mainEq.replace(/\d+\s*шт/gi, '').trim();
                    
                    if (mainEqName || additionalEq) {
                        equipment.push({
                            main: mainEqName,
                            mainQty: mainQty,
                            additional: additionalEq,
                            additionalQty: additionalQty
                        });
                    }
                }
            });
            
            return equipment;
        }
        
        // Функция для форматирования даты
        function formatDateForPDF(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString + 'T00:00:00');
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }
        
        // Функция для получения текста из select элемента
        function getSelectedText(selectId) {
            const select = document.getElementById(selectId);
            if (!select || !select.selectedIndex) return '';
            return select.options[select.selectedIndex].text;
        }
        
        // Функция для выгрузки формы в DOC (Word документ)
        window.exportToDOC = function(contractorType) {
            try {
                // Собираем все данные формы
                const storyTitle = contractorType === 'figaro' 
                    ? document.getElementById('figaro-story-title')?.value || ''
                    : document.getElementById('ttk-story-title')?.value || '';
                const annotation = contractorType === 'figaro'
                    ? document.getElementById('figaro-annotation')?.value || ''
                    : document.getElementById('ttk-annotation')?.value || '';
                const notes = contractorType === 'figaro'
                    ? document.getElementById('figaro-notes')?.value || ''
                    : document.getElementById('ttk-notes')?.value || '';
                const accreditation = contractorType === 'figaro'
                    ? document.getElementById('figaro-accreditation')?.value || 'no'
                    : document.getElementById('ttk-accreditation')?.value || 'no';
                
                const director = contractorType === 'figaro'
                    ? getSelectedText('figaro-director')
                    : getSelectedText('ttk-director');
                const correspondent = contractorType === 'figaro'
                    ? getSelectedText('figaro-correspondent')
                    : getSelectedText('ttk-correspondent');
                const producer = contractorType === 'figaro'
                    ? getSelectedText('figaro-producer')
                    : getSelectedText('ttk-producer');
                const operator = contractorType === 'figaro'
                    ? getSelectedText('figaro-operator')
                    : getSelectedText('ttk-operator');
                const videoEngineer = contractorType === 'figaro'
                    ? getSelectedText('figaro-video-engineer')
                    : getSelectedText('ttk-video-engineer');
                
                const applicationDate = contractorType === 'figaro'
                    ? document.getElementById('figaro-application-date')?.value || ''
                    : document.getElementById('ttk-application-date')?.value || '';
                const shootingDate = contractorType === 'figaro'
                    ? document.getElementById('figaro-shooting-date')?.value || ''
                    : document.getElementById('ttk-shooting-date')?.value || '';
                const startTime = contractorType === 'figaro'
                    ? document.getElementById('figaro-start-time')?.value || ''
                    : document.getElementById('ttk-start-time')?.value || '';
                const endTime = contractorType === 'figaro'
                    ? document.getElementById('figaro-end-time')?.value || ''
                    : document.getElementById('ttk-end-time')?.value || '';
                const broadcastDate = contractorType === 'figaro'
                    ? document.getElementById('figaro-broadcast-date')?.value || ''
                    : document.getElementById('ttk-broadcast-date')?.value || '';
                
                const equipment = collectEquipmentData(contractorType);
                
                const contractorName = contractorType === 'figaro' 
                    ? 'ВЕК XXL (ФИГАРО)' 
                    : 'Технологический центр ТВ (ТТК)';
                
                // Создаем HTML для печати
                let equipmentHtml = '';
                if (equipment.length > 0) {
                    equipmentHtml = '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    equipmentHtml += '<tr style="background-color: #f0f0f0;"><th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 45%;">Основной комплект</th><th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 45%;">Дополнительное оборудование</th></tr>';
                    equipment.forEach(eq => {
                        equipmentHtml += '<tr>';
                        equipmentHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${(eq.main || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')} ${eq.mainQty !== '0' ? eq.mainQty + ' шт' : ''}</td>`;
                        equipmentHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${(eq.additional || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')} ${eq.additionalQty !== '0' ? eq.additionalQty + ' шт' : ''}</td>`;
                        equipmentHtml += '</tr>';
                    });
                    equipmentHtml += '</table>';
                }
                
                let additionalFieldsHtml = '';
                if (contractorType === 'ttk') {
                    const clarifications = document.getElementById('ttk-clarifications')?.value || '';
                    const extension = document.getElementById('ttk-extension')?.value || '';
                    const carNumber = document.getElementById('ttk-car-number')?.value || '';
                    
                    if (clarifications) additionalFieldsHtml += `<p><strong>Уточнения:</strong> ${clarifications.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`;
                    if (extension) additionalFieldsHtml += `<p><strong>Продление:</strong> ${extension.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`;
                    if (carNumber) additionalFieldsHtml += `<p><strong>Номер автомобиля:</strong> ${carNumber.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`;
                }
                
                const printHtml = `
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заявка на видеосъемку</title>
    <style>
        @media print {
            @page {
                margin: 15mm;
            }
            body {
                margin: 0;
                padding: 0;
            }
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 210mm;
            margin: 0 auto;
            color: #000;
        }
        h1 {
            font-size: 20px;
            margin-bottom: 5px;
            color: #000;
        }
        h2 {
            font-size: 16px;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #000;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
        .header-info {
            margin-bottom: 20px;
            font-size: 12px;
        }
        p {
            margin: 8px 0;
            line-height: 1.6;
        }
        strong {
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        .footer {
            margin-top: 30px;
            font-size: 10px;
            color: #666;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>${contractorName}</h1>
    <div class="header-info">
        <p><strong>Заявка на видеосъемку</strong></p>
        <p>Программа "Доброе утро"</p>
    </div>
    
    <h2>Основная информация</h2>
    <p><strong>Название сюжета:</strong> ${(storyTitle || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
    <p><strong>Аннотация к съемке и адрес локации:</strong></p>
    <p style="white-space: pre-wrap; margin-left: 20px;">${(annotation || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
    ${notes ? `<p><strong>Примечания:</strong></p><p style="white-space: pre-wrap; margin-left: 20px;">${notes.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
    <p><strong>Аккредитация:</strong> ${accreditation === 'yes' ? 'ДА' : 'НЕТ'}</p>
    ${additionalFieldsHtml}
    
    <h2>Ответственные за проведение съемок</h2>
    ${director && director !== '-- Выберите редактора --' ? `<p><strong>Режиссер (редактор):</strong> ${director.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
    ${correspondent && correspondent !== '-- Выберите корреспондента --' ? `<p><strong>Корреспондент:</strong> ${correspondent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
    ${producer && producer !== '-- Выберите продюсера --' ? `<p><strong>Продюсер:</strong> ${producer.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
    ${operator && operator !== '-- Выберите оператора --' ? `<p><strong>Оператор:</strong> ${operator.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
    ${videoEngineer && videoEngineer !== '-- Выберите видео инженера --' ? `<p><strong>Видео инженер:</strong> ${videoEngineer.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
    
    <h2>Даты и время</h2>
    ${applicationDate ? `<p><strong>Дата подачи заявки:</strong> ${formatDateForPDF(applicationDate)}</p>` : ''}
    ${shootingDate ? `<p><strong>Дата съемки:</strong> ${formatDateForPDF(shootingDate)}</p>` : ''}
    ${startTime && endTime ? `<p><strong>Время выезда и завершения съемки:</strong> ${startTime} - ${endTime}</p>` : ''}
    ${broadcastDate ? `<p><strong>Дата эфира:</strong> ${formatDateForPDF(broadcastDate)}</p>` : ''}
    
    <h2>Оборудование</h2>
    ${equipmentHtml || '<p>Оборудование не указано</p>'}
    
    <div class="footer">
        <p>Создано: ${new Date().toLocaleString('ru-RU')}</p>
    </div>
    
    <script>
        window.onload = function() {
            window.print();
            window.onafterprint = function() {
                window.close();
            };
        };
    </script>
</body>
</html>`;
                
                // Создаем DOC файл (HTML формат с расширением .doc - Word отлично открывает)
                const docContent = printHtml.replace(/<script[\s\S]*?<\/script>/gi, ''); // Убираем скрипты
                
                // Создаем Blob с правильной кодировкой UTF-8
                const blob = new Blob(['\ufeff' + docContent], { 
                    type: 'application/msword;charset=utf-8' 
                });
                const url = URL.createObjectURL(blob);
                
                // Генерируем имя файла
                let fileName = `Заявка_${contractorType === 'figaro' ? 'ФИГАРО' : 'ТТК'}_${storyTitle.substring(0, 30).replace(/[<>:"/\\|?*]/g, '_')}`;
                if (shootingDate) {
                    const dateStr = shootingDate.split('-').reverse().join('.');
                    fileName += `_${dateStr}`;
                } else if (applicationDate) {
                    const dateStr = formatDateForPDF(applicationDate);
                    fileName += `_${dateStr}`;
                }
                fileName += '.doc';
                
                // Скачиваем файл
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('DOC файл успешно создан:', fileName);
                
            } catch (error) {
                console.error('Ошибка при создании DOC:', error);
                alert('Ошибка при создании DOC: ' + error.message);
            }
        };
        
        // УДАЛЕНО - функции для PDF больше не используются
        /*
        window.downloadHTMLForPDF = function(contractorType) {
            // Собираем все данные (та же логика, что и в exportFormToPDFViaPrint)
            const storyTitle = contractorType === 'figaro' 
                ? document.getElementById('figaro-story-title')?.value || ''
                : document.getElementById('ttk-story-title')?.value || '';
            const annotation = contractorType === 'figaro'
                ? document.getElementById('figaro-annotation')?.value || ''
                : document.getElementById('ttk-annotation')?.value || '';
            const notes = contractorType === 'figaro'
                ? document.getElementById('figaro-notes')?.value || ''
                : document.getElementById('ttk-notes')?.value || '';
            const accreditation = contractorType === 'figaro'
                ? document.getElementById('figaro-accreditation')?.value || 'no'
                : document.getElementById('ttk-accreditation')?.value || 'no';
            
            const director = contractorType === 'figaro'
                ? getSelectedText('figaro-director')
                : getSelectedText('ttk-director');
            const correspondent = contractorType === 'figaro'
                ? getSelectedText('figaro-correspondent')
                : getSelectedText('ttk-correspondent');
            const producer = contractorType === 'figaro'
                ? getSelectedText('figaro-producer')
                : getSelectedText('ttk-producer');
            const operator = contractorType === 'figaro'
                ? getSelectedText('figaro-operator')
                : getSelectedText('ttk-operator');
            const videoEngineer = contractorType === 'figaro'
                ? getSelectedText('figaro-video-engineer')
                : getSelectedText('ttk-video-engineer');
            
            const applicationDate = contractorType === 'figaro'
                ? document.getElementById('figaro-application-date')?.value || ''
                : document.getElementById('ttk-application-date')?.value || '';
            const shootingDate = contractorType === 'figaro'
                ? document.getElementById('figaro-shooting-date')?.value || ''
                : document.getElementById('ttk-shooting-date')?.value || '';
            const startTime = contractorType === 'figaro'
                ? document.getElementById('figaro-start-time')?.value || ''
                : document.getElementById('ttk-start-time')?.value || '';
            const endTime = contractorType === 'figaro'
                ? document.getElementById('figaro-end-time')?.value || ''
                : document.getElementById('ttk-end-time')?.value || '';
            const broadcastDate = contractorType === 'figaro'
                ? document.getElementById('figaro-broadcast-date')?.value || ''
                : document.getElementById('ttk-broadcast-date')?.value || '';
            
            const equipment = collectEquipmentData(contractorType);
            const contractorName = contractorType === 'figaro' 
                ? 'ВЕК XXL (ФИГАРО)' 
                : 'Технологический центр ТВ (ТТК)';
            
            // Создаем HTML (та же логика)
            let equipmentHtml = '';
            if (equipment.length > 0) {
                equipmentHtml = '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                equipmentHtml += '<tr style="background-color: #f0f0f0;"><th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 45%;">Основной комплект</th><th style="border: 1px solid #ddd; padding: 8px; text-align: left; width: 45%;">Дополнительное оборудование</th></tr>';
                equipment.forEach(eq => {
                    equipmentHtml += '<tr>';
                    equipmentHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${(eq.main || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')} ${eq.mainQty !== '0' ? eq.mainQty + ' шт' : ''}</td>`;
                    equipmentHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${(eq.additional || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')} ${eq.additionalQty !== '0' ? eq.additionalQty + ' шт' : ''}</td>`;
                    equipmentHtml += '</tr>';
                });
                equipmentHtml += '</table>';
            }
            
            let additionalFieldsHtml = '';
            if (contractorType === 'ttk') {
                const clarifications = document.getElementById('ttk-clarifications')?.value || '';
                const extension = document.getElementById('ttk-extension')?.value || '';
                const carNumber = document.getElementById('ttk-car-number')?.value || '';
                
                if (clarifications) additionalFieldsHtml += `<p><strong>Уточнения:</strong> ${clarifications.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`;
                if (extension) additionalFieldsHtml += `<p><strong>Продление:</strong> ${extension.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`;
                if (carNumber) additionalFieldsHtml += `<p><strong>Номер автомобиля:</strong> ${carNumber.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`;
            }
            
            const htmlContent = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <title>Заявка на видеосъемку</title>
    <style>
        @media print {
            @page { margin: 15mm; }
            body { margin: 0; padding: 0; }
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 210mm;
            margin: 0 auto;
            color: #000;
        }
        h1 { font-size: 20px; margin-bottom: 5px; }
        h2 { font-size: 16px; margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        .header-info { margin-bottom: 20px; font-size: 12px; }
        p { margin: 8px 0; line-height: 1.6; }
        strong { font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
        th { background-color: #f0f0f0; font-weight: bold; }
        .footer { margin-top: 30px; font-size: 10px; color: #666; text-align: center; }
    </style>
</head>
<body>
    <h1>${contractorName}</h1>
    <div class="header-info">
        <p><strong>Заявка на видеосъемку</strong></p>
        <p>Программа "Доброе утро"</p>
    </div>
    <h2>Основная информация</h2>
    <p><strong>Название сюжета:</strong> ${(storyTitle || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
    <p><strong>Аннотация к съемке и адрес локации:</strong></p>
    <p style="white-space: pre-wrap; margin-left: 20px;">${(annotation || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
    ${notes ? `<p><strong>Примечания:</strong></p><p style="white-space: pre-wrap; margin-left: 20px;">${notes.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
    <p><strong>Аккредитация:</strong> ${accreditation === 'yes' ? 'ДА' : 'НЕТ'}</p>
    ${additionalFieldsHtml}
    <h2>Ответственные за проведение съемок</h2>
    ${director && director !== '-- Выберите редактора --' ? `<p><strong>Режиссер (редактор):</strong> ${director.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
    ${correspondent && correspondent !== '-- Выберите корреспондента --' ? `<p><strong>Корреспондент:</strong> ${correspondent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
    ${producer && producer !== '-- Выберите продюсера --' ? `<p><strong>Продюсер:</strong> ${producer.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
    ${operator && operator !== '-- Выберите оператора --' ? `<p><strong>Оператор:</strong> ${operator.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
    ${videoEngineer && videoEngineer !== '-- Выберите видео инженера --' ? `<p><strong>Видео инженер:</strong> ${videoEngineer.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
    <h2>Даты и время</h2>
    ${applicationDate ? `<p><strong>Дата подачи заявки:</strong> ${formatDateForPDF(applicationDate)}</p>` : ''}
    ${shootingDate ? `<p><strong>Дата съемки:</strong> ${formatDateForPDF(shootingDate)}</p>` : ''}
    ${startTime && endTime ? `<p><strong>Время выезда и завершения съемки:</strong> ${startTime} - ${endTime}</p>` : ''}
    ${broadcastDate ? `<p><strong>Дата эфира:</strong> ${formatDateForPDF(broadcastDate)}</p>` : ''}
    <h2>Оборудование</h2>
    ${equipmentHtml || '<p>Оборудование не указано</p>'}
    <div class="footer">
        <p>Создано: ${new Date().toLocaleString('ru-RU')}</p>
    </div>
</body>
</html>`;
            
            // Создаем Blob и скачиваем файл
            const blob = new Blob(['\ufeff' + htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Заявка_${contractorType === 'figaro' ? 'ФИГАРО' : 'ТТК'}_${(shootingDate ? formatDateForPDF(shootingDate) : formatDateForPDF(applicationDate))}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('HTML файл скачан! Откройте его в браузере и используйте Ctrl+P (или Cmd+P на Mac) для печати в PDF. Русский текст будет отображаться корректно!');
        }
        
        // Простая функция для печати формы (рекомендуемый способ)
        // УДАЛЕНО - функция для PDF
        // window.printForm = function(contractorType) {
            try {
                // Скрываем всё, кроме формы
                const mainScreen = document.querySelector('.main-screen');
                const formContainer = contractorType === 'figaro' 
                    ? document.getElementById('formFigaro')
                    : document.getElementById('formTTK');
                
                if (!formContainer) {
                    alert('Форма не найдена');
                    return;
                }
                
                // Сохраняем исходные стили
                const originalStyles = {
                    mainScreen: mainScreen ? mainScreen.style.display : '',
                    formContainer: formContainer.style.display
                };
                
                // Скрываем главный экран, показываем только форму
                if (mainScreen) mainScreen.style.display = 'none';
                formContainer.style.display = 'block';
                
                // Прокручиваем к форме
                formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Добавляем CSS для печати
                const style = document.createElement('style');
                style.id = 'print-style';
                style.textContent = `
                    @media print {
                        body * {
                            visibility: hidden;
                        }
                        #formFigaro, #formTTK {
                            visibility: visible;
                            position: absolute;
                            left: 0;
                            top: 0;
                            width: 100%;
                        }
                        .form-actions {
                            display: none !important;
                        }
                        .back-btn {
                            display: none !important;
                        }
                        @page {
                            margin: 15mm;
                        }
                    }
                `;
                document.head.appendChild(style);
                
                // Показываем подсказку
                setTimeout(() => {
                    alert('💡 В открывшемся диалоге печати:\n\n1. Выберите "Сохранить как PDF" или "Microsoft Print to PDF"\n2. Нажмите "Сохранить"\n3. Выберите место для сохранения\n\n✅ Русский текст будет отображаться корректно!');
                    
                    // Вызываем печать
                    window.print();
                    
                    // Восстанавливаем стили после печати
                    window.onafterprint = function() {
                        if (mainScreen) mainScreen.style.display = originalStyles.mainScreen;
                        formContainer.style.display = originalStyles.formContainer;
                        const printStyle = document.getElementById('print-style');
                        if (printStyle) printStyle.remove();
                    };
                    
                    // Также восстанавливаем через некоторое время (на случай, если onafterprint не сработал)
                    setTimeout(() => {
                        if (mainScreen) mainScreen.style.display = originalStyles.mainScreen;
                        formContainer.style.display = originalStyles.formContainer;
                        const printStyle = document.getElementById('print-style');
                        if (printStyle) printStyle.remove();
                    }, 500);
                }, 300);
                
            } catch (error) {
                console.error('Ошибка при печати:', error);
                alert('Ошибка при печати: ' + error.message);
            }
        };
        
        // УДАЛЕНО - функция для PDF
        // window.exportFormToPDF = function(contractorType) {
    </script>
    <!-- Модальное окно для улучшенной ручной отправки -->
    <div class="email-modal-overlay" id="emailModalOverlay">
        <div class="email-modal">
            <button class="email-modal-close" onclick="closeEmailModal()">×</button>
            
            <div class="email-success-icon">✅</div>
            
            <h2 style="text-align: center; margin-bottom: 20px; color: #333;">
                Заявка создана успешно!
            </h2>
            
            <div class="email-file-info">
                <div class="email-file-name">
                    📄 Файл Word скачан:
                </div>
                <div style="font-weight: bold; color: #2196F3; margin: 10px 0; word-break: break-all;" id="emailFileName">
                    Заявка.doc
                </div>
                <div class="email-file-path">
                    📍 Расположение: <span id="emailFilePath">Папка "Загрузки"</span>
                </div>
            </div>
            
            <div class="email-instructions">
                <strong>📧 Инструкция по отправке:</strong>
                <ol>
                    <li>Нажмите кнопку "Открыть почтовый клиент" ниже</li>
                    <li>В открывшемся письме прикрепите файл Word (он уже скачан в папку "Загрузки")</li>
                    <li>Проверьте тему и текст письма</li>
                    <li>Нажмите "Отправить"</li>
                </ol>
            </div>
            
            <div class="email-tip">
                <strong>💡 Подсказка:</strong> Если файл не прикрепился автоматически, найдите его в папке "Загрузки" и прикрепите вручную.
            </div>
            
            <div class="email-action-buttons">
                <button class="email-btn email-btn-primary" onclick="openEmailClientFromModal()">
                    📧 Открыть почтовый клиент
                </button>
                <button class="email-btn email-btn-secondary" onclick="showDownloadsFolderInfo()">
                    📁 Информация о файле
                </button>
                <button class="email-btn email-btn-close" onclick="closeEmailModal()">
                    ✖ Закрыть
                </button>
            </div>
        </div>
    </div>
    
    <!-- EmailJS для отправки писем -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <!-- SheetJS для работы с Excel файлами -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- ExcelJS для лучшей работы со стилями -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <!-- xlsx-populate для работы с шаблонами (лучше сохраняет стили) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-populate@1.21.0/browser/xlsx-populate.min.js"></script>
    <!-- jsPDF и html2canvas для генерации PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- pdfmake для генерации PDF с поддержкой кириллицы -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js"></script>
    <script src="auth.js"></script>
    <script src="email-service.js"></script>
    <script src="data.js"></script>
    <script>
        // Проверка авторизации при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Ждем загрузки auth.js
            setTimeout(function() {
                if (typeof authManager === 'undefined') {
                    console.error('authManager не загружен');
                    return;
                }
                
                if (!authManager.isAuthenticated()) {
                    alert('Пожалуйста, войдите в систему для доступа к этой странице');
                    window.location.href = 'index.html';
                }
            }, 100);
        });
    </script>
</body>
</html>